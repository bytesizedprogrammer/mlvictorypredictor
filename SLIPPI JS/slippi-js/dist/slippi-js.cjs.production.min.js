"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("lodash/get"),t=require("lodash/isEqual"),r=require("lodash/keyBy"),n=require("lodash/last"),s=require("lodash/set"),a=require("lodash/size"),o=require("events"),i=require("lodash/filter"),l=require("lodash/groupBy"),E=require("lodash/orderBy"),T=require("lodash/first"),c=require("lodash/flatten"),u=require("lodash/mapValues"),_=require("lodash/zip"),p=require("date-fns"),A=require("fs"),m=require("lodash/forEach"),h=require("stream"),S=require("@shelacek/ubjson"),d=require("net"),N=require("reconnect-core"),f=require("iconv-lite"),R=require("lodash/map"),I=require("path"),C=require("semver");function O(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function g(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,t}var F=O(e),D=O(t),x=O(r),M=O(n),G=O(s),B=O(a),y=O(i),L=O(l),P=O(E),U=O(T),H=O(c),v=O(u),w=O(_),k=O(A),W=O(m),V=O(d),b=O(N),Y=O(f),K=O(R),J=O(I),X=O(C),j={0:{name:"Captain Falcon",shortName:"Falcon",colors:["Black","Red","White","Green","Blue"]},1:{name:"Donkey Kong",shortName:"DK",colors:["Black","Red","Blue","Green"]},2:{name:"Fox",colors:["Red","Blue","Green"]},3:{name:"Mr. Game & Watch",shortName:"G&W",colors:["Red","Blue","Green"]},4:{name:"Kirby",colors:["Yellow","Blue","Red","Green","White"]},5:{name:"Bowser",colors:["Red","Blue","Black"]},6:{name:"Link",colors:["Red","Blue","Black","White"]},7:{name:"Luigi",colors:["White","Blue","Red"]},8:{name:"Mario",colors:["Yellow","Black","Blue","Green"]},9:{name:"Marth",colors:["Red","Green","Black","White"]},10:{name:"Mewtwo",colors:["Red","Blue","Green"]},11:{name:"Ness",colors:["Yellow","Blue","Green"]},12:{name:"Peach",colors:["Daisy","White","Blue","Green"]},13:{name:"Pikachu",colors:["Red","Party Hat","Cowboy Hat"]},14:{name:"Ice Climbers",shortName:"ICs",colors:["Green","Orange","Red"]},15:{name:"Jigglypuff",shortName:"Puff",colors:["Red","Blue","Headband","Crown"]},16:{name:"Samus",colors:["Pink","Black","Green","Purple"]},17:{name:"Yoshi",colors:["Red","Blue","Yellow","Pink","Cyan"]},18:{name:"Zelda",colors:["Red","Blue","Green","White"]},19:{name:"Sheik",colors:["Red","Blue","Green","White"]},20:{name:"Falco",colors:["Red","Blue","Green"]},21:{name:"Young Link",shortName:"YLink",colors:["Red","Blue","White","Black"]},22:{name:"Dr. Mario",shortName:"Doc",colors:["Red","Blue","Green","Black"]},23:{name:"Roy",colors:["Red","Blue","Green","Yellow"]},24:{name:"Pichu",colors:["Red","Blue","Green"]},25:{name:"Ganondorf",shortName:"Ganon",colors:["Red","Blue","Green","Purple"]},26:{name:"Master Hand"},27:{name:"Wireframe (Male)"},28:{name:"Wireframe (Female)"},29:{name:"Gigabowser"},30:{name:"Crazy Hand"},31:{name:"Sandbag"},32:{name:"Popo"}};const z={id:-1,name:"Unknown Character",shortName:"Unknown",colors:["Default"]};function $(e,t){var r,n;return t?{id:e,name:t.name,shortName:null!=(r=t.shortName)?r:t.name,colors:["Default",...null!=(n=t.colors)?n:[]]}:z}function q(e){const t=j[e.toString()];return $(e,t)}var Z={__proto__:null,UnknownCharacter:z,getAllCharacters:function(){return Object.entries(j).map((([e,t])=>$(parseInt(e,10),t))).sort(((e,t)=>e.id-t.id))},getCharacterInfo:q,getCharacterShortName:function(e){return q(e).shortName},getCharacterName:function(e){return q(e).name},getCharacterColorName:function(e,t){return q(e).colors[t]||"Default"}},Q={1:{name:"Miscellaneous",shortName:"misc"},2:{name:"Jab",shortName:"jab"},3:{name:"Jab",shortName:"jab"},4:{name:"Jab",shortName:"jab"},5:{name:"Rapid Jabs",shortName:"rapid-jabs"},6:{name:"Dash Attack",shortName:"dash"},7:{name:"Forward Tilt",shortName:"ftilt"},8:{name:"Up Tilt",shortName:"utilt"},9:{name:"Down Tilt",shortName:"dtilt"},10:{name:"Forward Smash",shortName:"fsmash"},11:{name:"Up Smash",shortName:"usmash"},12:{name:"Down Smash",shortName:"dsmash"},13:{name:"Neutral Air",shortName:"nair"},14:{name:"Forward Air",shortName:"fair"},15:{name:"Back Air",shortName:"bair"},16:{name:"Up Air",shortName:"uair"},17:{name:"Down Air",shortName:"dair"},18:{name:"Neutral B",shortName:"neutral-b"},19:{name:"Side B",shortName:"side-b"},20:{name:"Up B",shortName:"up-b"},21:{name:"Down B",shortName:"down-b"},50:{name:"Getup Attack",shortName:"getup"},51:{name:"Getup Attack (Slow)",shortName:"getup-slow"},52:{name:"Grab Pummel",shortName:"pummel"},53:{name:"Forward Throw",shortName:"fthrow"},54:{name:"Back Throw",shortName:"bthrow"},55:{name:"Up Throw",shortName:"uthrow"},56:{name:"Down Throw",shortName:"dthrow"},61:{name:"Edge Attack (Slow)",shortName:"edge-slow"},62:{name:"Edge Attack",shortName:"edge"}};const ee={id:-1,name:"Unknown Move",shortName:"unknown"};function te(e){const t=Q[e.toString()];return t?{id:e,name:t.name,shortName:t.shortName}:ee}var re={__proto__:null,UnknownMove:ee,getMoveInfo:te,getMoveShortName:function(e){return te(e).shortName},getMoveName:function(e){return te(e).name}},ne={2:"Fountain of Dreams",3:"Pokémon Stadium",4:"Princess Peach's Castle",5:"Kongo Jungle",6:"Brinstar",7:"Corneria",8:"Yoshi's Story",9:"Onett",10:"Mute City",11:"Rainbow Cruise",12:"Jungle Japes",13:"Great Bay",14:"Hyrule Temple",15:"Brinstar Depths",16:"Yoshi's Island",17:"Green Greens",18:"Fourside",19:"Mushroom Kingdom I",20:"Mushroom Kingdom II",22:"Venom",23:"Poké Floats",24:"Big Blue",25:"Icicle Mountain",26:"Icetop",27:"Flat Zone",28:"Dream Land N64",29:"Yoshi's Island N64",30:"Kongo Jungle N64",31:"Battlefield",32:"Final Destination",33:"Target Test (Mario)",34:"Target Test (Captain Falcon)",35:"Target Test (Young Link)",36:"Target Test (Donkey Kong)",37:"Target Test (Dr. Mario)",38:"Target Test (Falco)",39:"Target Test (Fox)",40:"Target Test (Ice Climbers)",41:"Target Test (Kirby)",42:"Target Test (Bowser)",43:"Target Test (Link)",44:"Target Test (Luigi)",45:"Target Test (Marth)",46:"Target Test (Mewtwo)",47:"Target Test (Ness)",48:"Target Test (Peach)",49:"Target Test (Pichu)",50:"Target Test (Pikachu)",51:"Target Test (Jigglypuff)",52:"Target Test (Samus)",53:"Target Test (Sheik)",54:"Target Test (Yoshi)",55:"Target Test (Zelda)",56:"Target Test (Mr. Game & Watch)",57:"Target Test (Roy)",58:"Target Test (Ganondorf)",84:"Home-Run Contest"};const se={id:-1,name:"Unknown Stage"};function ae(e){const t=ne[e.toString()];return t?{id:e,name:t}:se}var oe,ie,le,Ee={__proto__:null,UnknownStage:se,getStageInfo:ae,getStageName:function(e){return ae(e).name}};exports.Character=void 0,(oe=exports.Character||(exports.Character={}))[oe.CAPTAIN_FALCON=0]="CAPTAIN_FALCON",oe[oe.DONKEY_KONG=1]="DONKEY_KONG",oe[oe.FOX=2]="FOX",oe[oe.GAME_AND_WATCH=3]="GAME_AND_WATCH",oe[oe.KIRBY=4]="KIRBY",oe[oe.BOWSER=5]="BOWSER",oe[oe.LINK=6]="LINK",oe[oe.LUIGI=7]="LUIGI",oe[oe.MARIO=8]="MARIO",oe[oe.MARTH=9]="MARTH",oe[oe.MEWTWO=10]="MEWTWO",oe[oe.NESS=11]="NESS",oe[oe.PEACH=12]="PEACH",oe[oe.PIKACHU=13]="PIKACHU",oe[oe.ICE_CLIMBERS=14]="ICE_CLIMBERS",oe[oe.JIGGLYPUFF=15]="JIGGLYPUFF",oe[oe.SAMUS=16]="SAMUS",oe[oe.YOSHI=17]="YOSHI",oe[oe.ZELDA=18]="ZELDA",oe[oe.SHEIK=19]="SHEIK",oe[oe.FALCO=20]="FALCO",oe[oe.YOUNG_LINK=21]="YOUNG_LINK",oe[oe.DR_MARIO=22]="DR_MARIO",oe[oe.ROY=23]="ROY",oe[oe.PICHU=24]="PICHU",oe[oe.GANONDORF=25]="GANONDORF",oe[oe.MASTER_HAND=26]="MASTER_HAND",oe[oe.WIREFRAME_MALE=27]="WIREFRAME_MALE",oe[oe.WIREFRAME_FEMALE=28]="WIREFRAME_FEMALE",oe[oe.GIGA_BOWSER=29]="GIGA_BOWSER",oe[oe.CRAZY_HAND=30]="CRAZY_HAND",oe[oe.SANDBAG=31]="SANDBAG",oe[oe.POPO=32]="POPO",exports.Stage=void 0,(ie=exports.Stage||(exports.Stage={}))[ie.FOUNTAIN_OF_DREAMS=2]="FOUNTAIN_OF_DREAMS",ie[ie.POKEMON_STADIUM=3]="POKEMON_STADIUM",ie[ie.PEACHS_CASTLE=4]="PEACHS_CASTLE",ie[ie.KONGO_JUNGLE=5]="KONGO_JUNGLE",ie[ie.BRINSTAR=6]="BRINSTAR",ie[ie.CORNERIA=7]="CORNERIA",ie[ie.YOSHIS_STORY=8]="YOSHIS_STORY",ie[ie.ONETT=9]="ONETT",ie[ie.MUTE_CITY=10]="MUTE_CITY",ie[ie.RAINBOW_CRUISE=11]="RAINBOW_CRUISE",ie[ie.JUNGLE_JAPES=12]="JUNGLE_JAPES",ie[ie.GREAT_BAY=13]="GREAT_BAY",ie[ie.HYRULE_TEMPLE=14]="HYRULE_TEMPLE",ie[ie.BRINSTAR_DEPTHS=15]="BRINSTAR_DEPTHS",ie[ie.YOSHIS_ISLAND=16]="YOSHIS_ISLAND",ie[ie.GREEN_GREENS=17]="GREEN_GREENS",ie[ie.FOURSIDE=18]="FOURSIDE",ie[ie.MUSHROOM_KINGDOM=19]="MUSHROOM_KINGDOM",ie[ie.MUSHROOM_KINGDOM_2=20]="MUSHROOM_KINGDOM_2",ie[ie.VENOM=22]="VENOM",ie[ie.POKE_FLOATS=23]="POKE_FLOATS",ie[ie.BIG_BLUE=24]="BIG_BLUE",ie[ie.ICICLE_MOUNTAIN=25]="ICICLE_MOUNTAIN",ie[ie.ICETOP=26]="ICETOP",ie[ie.FLAT_ZONE=27]="FLAT_ZONE",ie[ie.DREAMLAND=28]="DREAMLAND",ie[ie.YOSHIS_ISLAND_N64=29]="YOSHIS_ISLAND_N64",ie[ie.KONGO_JUNGLE_N64=30]="KONGO_JUNGLE_N64",ie[ie.BATTLEFIELD=31]="BATTLEFIELD",ie[ie.FINAL_DESTINATION=32]="FINAL_DESTINATION",ie[ie.TARGET_TEST_MARIO=33]="TARGET_TEST_MARIO",ie[ie.TARGET_TEST_CAPTAIN_FALCON=34]="TARGET_TEST_CAPTAIN_FALCON",ie[ie.TARGET_TEST_YOUNG_LINK=35]="TARGET_TEST_YOUNG_LINK",ie[ie.TARGET_TEST_DONKEY_KONG=36]="TARGET_TEST_DONKEY_KONG",ie[ie.TARGET_TEST_DR_MARIO=37]="TARGET_TEST_DR_MARIO",ie[ie.TARGET_TEST_FALCO=38]="TARGET_TEST_FALCO",ie[ie.TARGET_TEST_FOX=39]="TARGET_TEST_FOX",ie[ie.TARGET_TEST_ICE_CLIMBERS=40]="TARGET_TEST_ICE_CLIMBERS",ie[ie.TARGET_TEST_KIRBY=41]="TARGET_TEST_KIRBY",ie[ie.TARGET_TEST_BOWSER=42]="TARGET_TEST_BOWSER",ie[ie.TARGET_TEST_LINK=43]="TARGET_TEST_LINK",ie[ie.TARGET_TEST_LUIGI=44]="TARGET_TEST_LUIGI",ie[ie.TARGET_TEST_MARTH=45]="TARGET_TEST_MARTH",ie[ie.TARGET_TEST_MEWTWO=46]="TARGET_TEST_MEWTWO",ie[ie.TARGET_TEST_NESS=47]="TARGET_TEST_NESS",ie[ie.TARGET_TEST_PEACH=48]="TARGET_TEST_PEACH",ie[ie.TARGET_TEST_PICHU=49]="TARGET_TEST_PICHU",ie[ie.TARGET_TEST_PIKACHU=50]="TARGET_TEST_PIKACHU",ie[ie.TARGET_TEST_JIGGLYPUFF=51]="TARGET_TEST_JIGGLYPUFF",ie[ie.TARGET_TEST_SAMUS=52]="TARGET_TEST_SAMUS",ie[ie.TARGET_TEST_SHEIK=53]="TARGET_TEST_SHEIK",ie[ie.TARGET_TEST_YOSHI=54]="TARGET_TEST_YOSHI",ie[ie.TARGET_TEST_ZELDA=55]="TARGET_TEST_ZELDA",ie[ie.TARGET_TEST_GAME_AND_WATCH=56]="TARGET_TEST_GAME_AND_WATCH",ie[ie.TARGET_TEST_ROY=57]="TARGET_TEST_ROY",ie[ie.TARGET_TEST_GANONDORF=58]="TARGET_TEST_GANONDORF",ie[ie.RACE_TO_THE_FINISH=82]="RACE_TO_THE_FINISH",ie[ie.GRAB_THE_TROPHIES=83]="GRAB_THE_TROPHIES",ie[ie.HOME_RUN_CONTEST=84]="HOME_RUN_CONTEST",ie[ie.ALL_STAR_LOBBY=85]="ALL_STAR_LOBBY",ie[ie.EVENT_ONE=202]="EVENT_ONE",ie[ie.EVENT_EIGHTEEN=203]="EVENT_EIGHTEEN",ie[ie.EVENT_THREE=204]="EVENT_THREE",ie[ie.EVENT_FOUR=205]="EVENT_FOUR",ie[ie.EVENT_FIVE=206]="EVENT_FIVE",ie[ie.EVENT_SIX=207]="EVENT_SIX",ie[ie.EVENT_SEVEN=208]="EVENT_SEVEN",ie[ie.EVENT_EIGHT=209]="EVENT_EIGHT",ie[ie.EVENT_NINE=210]="EVENT_NINE",ie[ie.EVENT_TEN_PART_ONE=211]="EVENT_TEN_PART_ONE",ie[ie.EVENT_ELEVEN=212]="EVENT_ELEVEN",ie[ie.EVENT_TWELVE=213]="EVENT_TWELVE",ie[ie.EVENT_THIRTEEN=214]="EVENT_THIRTEEN",ie[ie.EVENT_FOURTEEN=215]="EVENT_FOURTEEN",ie[ie.EVENT_THIRTY_SEVEN=216]="EVENT_THIRTY_SEVEN",ie[ie.EVENT_SIXTEEN=217]="EVENT_SIXTEEN",ie[ie.EVENT_SEVENTEEN=218]="EVENT_SEVENTEEN",ie[ie.EVENT_TWO=219]="EVENT_TWO",ie[ie.EVENT_NINETEEN=220]="EVENT_NINETEEN",ie[ie.EVENT_TWENTY_PART_ONE=221]="EVENT_TWENTY_PART_ONE",ie[ie.EVENT_TWENTY_ONE=222]="EVENT_TWENTY_ONE",ie[ie.EVENT_TWENTY_TWO=223]="EVENT_TWENTY_TWO",ie[ie.EVENT_TWENTY_SEVEN=224]="EVENT_TWENTY_SEVEN",ie[ie.EVENT_TWENTY_FOUR=225]="EVENT_TWENTY_FOUR",ie[ie.EVENT_TWENTY_FIVE=226]="EVENT_TWENTY_FIVE",ie[ie.EVENT_TWENTY_SIX=227]="EVENT_TWENTY_SIX",ie[ie.EVENT_TWENTY_THREE=228]="EVENT_TWENTY_THREE",ie[ie.EVENT_TWENTY_EIGHT=229]="EVENT_TWENTY_EIGHT",ie[ie.EVENT_TWENTY_NINE=230]="EVENT_TWENTY_NINE",ie[ie.EVENT_THIRTY_PART_ONE=231]="EVENT_THIRTY_PART_ONE",ie[ie.EVENT_THIRTY_ONE=232]="EVENT_THIRTY_ONE",ie[ie.EVENT_THIRTY_TWO=233]="EVENT_THIRTY_TWO",ie[ie.EVENT_THIRTY_THREE=234]="EVENT_THIRTY_THREE",ie[ie.EVENT_THIRTY_FOUR=235]="EVENT_THIRTY_FOUR",ie[ie.EVENT_FORTY_EIGHT=236]="EVENT_FORTY_EIGHT",ie[ie.EVENT_THIRTY_SIX_PART_ONE=237]="EVENT_THIRTY_SIX_PART_ONE",ie[ie.EVENT_FIFTEEN=238]="EVENT_FIFTEEN",ie[ie.EVENT_THIRTY_EIGHT=239]="EVENT_THIRTY_EIGHT",ie[ie.EVENT_THIRTY_NINE=240]="EVENT_THIRTY_NINE",ie[ie.EVENT_FORTY_PART_ONE=241]="EVENT_FORTY_PART_ONE",ie[ie.EVENT_FORTY_ONE=242]="EVENT_FORTY_ONE",ie[ie.EVENT_FORTY_TWO=243]="EVENT_FORTY_TWO",ie[ie.EVENT_FORTY_THREE=244]="EVENT_FORTY_THREE",ie[ie.EVENT_FORTY_FOUR=245]="EVENT_FORTY_FOUR",ie[ie.EVENT_FORTY_FIVE=246]="EVENT_FORTY_FIVE",ie[ie.EVENT_FORTY_SIX=247]="EVENT_FORTY_SIX",ie[ie.EVENT_FORTY_SEVEN=248]="EVENT_FORTY_SEVEN",ie[ie.EVENT_THIRTY_FIVE=249]="EVENT_THIRTY_FIVE",ie[ie.EVENT_FORTY_NINE_PART_ONE=250]="EVENT_FORTY_NINE_PART_ONE",ie[ie.EVENT_FIFTY=251]="EVENT_FIFTY",ie[ie.EVENT_FIFTY_ONE=252]="EVENT_FIFTY_ONE",ie[ie.EVENT_TEN_PART_TWO=253]="EVENT_TEN_PART_TWO",ie[ie.EVENT_TEN_PART_THREE=254]="EVENT_TEN_PART_THREE",ie[ie.EVENT_TEN_PART_FOUR=255]="EVENT_TEN_PART_FOUR",ie[ie.EVENT_TEN_PART_FIVE=256]="EVENT_TEN_PART_FIVE",ie[ie.EVENT_TWENTY_PART_TWO=257]="EVENT_TWENTY_PART_TWO",ie[ie.EVENT_TWENTY_PART_THREE=258]="EVENT_TWENTY_PART_THREE",ie[ie.EVENT_TWENTY_PART_FOUR=259]="EVENT_TWENTY_PART_FOUR",ie[ie.EVENT_TWENTY_PART_FIVE=260]="EVENT_TWENTY_PART_FIVE",ie[ie.EVENT_THIRTY_PART_TWO=261]="EVENT_THIRTY_PART_TWO",ie[ie.EVENT_THIRTY_PART_THREE=262]="EVENT_THIRTY_PART_THREE",ie[ie.EVENT_THIRTY_PART_FOUR=263]="EVENT_THIRTY_PART_FOUR",ie[ie.EVENT_FORTY_PART_TWO=264]="EVENT_FORTY_PART_TWO",ie[ie.EVENT_FORTY_PART_THREE=265]="EVENT_FORTY_PART_THREE",ie[ie.EVENT_FORTY_PART_FOUR=266]="EVENT_FORTY_PART_FOUR",ie[ie.EVENT_FORTY_PART_FIVE=267]="EVENT_FORTY_PART_FIVE",ie[ie.EVENT_FORTY_NINE_PART_TWO=268]="EVENT_FORTY_NINE_PART_TWO",ie[ie.EVENT_FORTY_NINE_PART_THREE=269]="EVENT_FORTY_NINE_PART_THREE",ie[ie.EVENT_FORTY_NINE_PART_FOUR=270]="EVENT_FORTY_NINE_PART_FOUR",ie[ie.EVENT_FORTY_NINE_PART_FIVE=271]="EVENT_FORTY_NINE_PART_FIVE",ie[ie.EVENT_FORTY_NINE_PART_SIX=272]="EVENT_FORTY_NINE_PART_SIX",ie[ie.EVENT_THIRTY_SIX_PART_TWO=273]="EVENT_THIRTY_SIX_PART_TWO",ie[ie.MULTI_MAN_MELEE=285]="MULTI_MAN_MELEE",exports.State=void 0,(le=exports.State||(exports.State={}))[le.DAMAGE_START=75]="DAMAGE_START",le[le.DAMAGE_END=91]="DAMAGE_END",le[le.CAPTURE_START=223]="CAPTURE_START",le[le.CAPTURE_END=232]="CAPTURE_END",le[le.GUARD_START=178]="GUARD_START",le[le.GUARD_END=182]="GUARD_END",le[le.GROUNDED_CONTROL_START=14]="GROUNDED_CONTROL_START",le[le.GROUNDED_CONTROL_END=24]="GROUNDED_CONTROL_END",le[le.SQUAT_START=39]="SQUAT_START",le[le.SQUAT_END=41]="SQUAT_END",le[le.DOWN_START=183]="DOWN_START",le[le.DOWN_END=198]="DOWN_END",le[le.TECH_START=199]="TECH_START",le[le.TECH_END=204]="TECH_END",le[le.DYING_START=0]="DYING_START",le[le.DYING_END=10]="DYING_END",le[le.CONTROLLED_JUMP_START=24]="CONTROLLED_JUMP_START",le[le.CONTROLLED_JUMP_END=34]="CONTROLLED_JUMP_END",le[le.GROUND_ATTACK_START=44]="GROUND_ATTACK_START",le[le.GROUND_ATTACK_END=64]="GROUND_ATTACK_END",le[le.AERIAL_ATTACK_START=65]="AERIAL_ATTACK_START",le[le.AERIAL_ATTACK_END=74]="AERIAL_ATTACK_END",le[le.ATTACK_FTILT_START=51]="ATTACK_FTILT_START",le[le.ATTACK_FTILT_END=55]="ATTACK_FTILT_END",le[le.ATTACK_FSMASH_START=58]="ATTACK_FSMASH_START",le[le.ATTACK_FSMASH_END=62]="ATTACK_FSMASH_END",le[le.ROLL_FORWARD=233]="ROLL_FORWARD",le[le.ROLL_BACKWARD=234]="ROLL_BACKWARD",le[le.SPOT_DODGE=235]="SPOT_DODGE",le[le.AIR_DODGE=236]="AIR_DODGE",le[le.ACTION_WAIT=14]="ACTION_WAIT",le[le.ACTION_DASH=20]="ACTION_DASH",le[le.ACTION_KNEE_BEND=24]="ACTION_KNEE_BEND",le[le.GUARD_ON=178]="GUARD_ON",le[le.TECH_MISS_UP=183]="TECH_MISS_UP",le[le.JAB_RESET_UP=185]="JAB_RESET_UP",le[le.TECH_MISS_DOWN=191]="TECH_MISS_DOWN",le[le.JAB_RESET_DOWN=193]="JAB_RESET_DOWN",le[le.NEUTRAL_TECH=199]="NEUTRAL_TECH",le[le.FORWARD_TECH=200]="FORWARD_TECH",le[le.BACKWARD_TECH=201]="BACKWARD_TECH",le[le.WALL_TECH=202]="WALL_TECH",le[le.MISSED_WALL_TECH=247]="MISSED_WALL_TECH",le[le.DASH=20]="DASH",le[le.TURN=18]="TURN",le[le.LANDING_FALL_SPECIAL=43]="LANDING_FALL_SPECIAL",le[le.JUMP_FORWARD=25]="JUMP_FORWARD",le[le.JUMP_BACKWARD=26]="JUMP_BACKWARD",le[le.FALL_FORWARD=30]="FALL_FORWARD",le[le.FALL_BACKWARD=31]="FALL_BACKWARD",le[le.GRAB=212]="GRAB",le[le.DASH_GRAB=214]="DASH_GRAB",le[le.GRAB_WAIT=216]="GRAB_WAIT",le[le.PUMMEL=217]="PUMMEL",le[le.CLIFF_CATCH=252]="CLIFF_CATCH",le[le.THROW_UP=221]="THROW_UP",le[le.THROW_FORWARD=219]="THROW_FORWARD",le[le.THROW_DOWN=222]="THROW_DOWN",le[le.THROW_BACK=220]="THROW_BACK",le[le.DAMAGE_FALL=38]="DAMAGE_FALL",le[le.ATTACK_JAB1=44]="ATTACK_JAB1",le[le.ATTACK_JAB2=45]="ATTACK_JAB2",le[le.ATTACK_JAB3=46]="ATTACK_JAB3",le[le.ATTACK_JABM=47]="ATTACK_JABM",le[le.ATTACK_DASH=50]="ATTACK_DASH",le[le.ATTACK_UTILT=56]="ATTACK_UTILT",le[le.ATTACK_DTILT=57]="ATTACK_DTILT",le[le.ATTACK_USMASH=63]="ATTACK_USMASH",le[le.ATTACK_DSMASH=64]="ATTACK_DSMASH",le[le.AERIAL_NAIR=65]="AERIAL_NAIR",le[le.AERIAL_FAIR=66]="AERIAL_FAIR",le[le.AERIAL_BAIR=67]="AERIAL_BAIR",le[le.AERIAL_UAIR=68]="AERIAL_UAIR",le[le.AERIAL_DAIR=69]="AERIAL_DAIR",le[le.GNW_JAB1=341]="GNW_JAB1",le[le.GNW_JABM=342]="GNW_JABM",le[le.GNW_DTILT=345]="GNW_DTILT",le[le.GNW_FSMASH=346]="GNW_FSMASH",le[le.GNW_NAIR=347]="GNW_NAIR",le[le.GNW_BAIR=348]="GNW_BAIR",le[le.GNW_UAIR=349]="GNW_UAIR",le[le.PEACH_FSMASH1=349]="PEACH_FSMASH1",le[le.PEACH_FSMASH2=350]="PEACH_FSMASH2",le[le.PEACH_FSMASH3=351]="PEACH_FSMASH3",le[le.BARREL_WAIT=293]="BARREL_WAIT",le[le.COMMAND_GRAB_RANGE1_START=266]="COMMAND_GRAB_RANGE1_START",le[le.COMMAND_GRAB_RANGE1_END=304]="COMMAND_GRAB_RANGE1_END",le[le.COMMAND_GRAB_RANGE2_START=327]="COMMAND_GRAB_RANGE2_START",le[le.COMMAND_GRAB_RANGE2_END=338]="COMMAND_GRAB_RANGE2_END";const Te={PUNISH_RESET_FRAMES:45,RECOVERY_RESET_FRAMES:45,COMBO_STRING_RESET_FRAMES:45};function ce(e){return e&&2===e.players.length?[{playerIndex:e.players[0].playerIndex,opponentIndex:e.players[1].playerIndex},{playerIndex:e.players[1].playerIndex,opponentIndex:e.players[0].playerIndex}]:[]}function ue(e,t){return!(!e||!t)&&t.stocksRemaining-e.stocksRemaining>0}function _e(e){const t=e>=exports.State.GROUNDED_CONTROL_START&&e<=exports.State.GROUNDED_CONTROL_END,r=e>=exports.State.SQUAT_START&&e<=exports.State.SQUAT_END,n=e>exports.State.GROUND_ATTACK_START&&e<=exports.State.GROUND_ATTACK_END,s=e===exports.State.GRAB;return t||r||n||s}function pe(e){return e>=exports.State.TECH_START&&e<=exports.State.TECH_END}function Ae(e){return e>=exports.State.DOWN_START&&e<=exports.State.DOWN_END}function me(e){return e>=exports.State.DAMAGE_START&&e<=exports.State.DAMAGE_END||e===exports.State.DAMAGE_FALL||e===exports.State.JAB_RESET_UP||e===exports.State.JAB_RESET_DOWN}function he(e){return e>=exports.State.CAPTURE_START&&e<=exports.State.CAPTURE_END}function Se(e){return(e>=exports.State.COMMAND_GRAB_RANGE1_START&&e<=exports.State.COMMAND_GRAB_RANGE1_END||e>=exports.State.COMMAND_GRAB_RANGE2_START&&e<=exports.State.COMMAND_GRAB_RANGE2_END)&&e!==exports.State.BARREL_WAIT}function de(e){return e>=exports.State.DYING_START&&e<=exports.State.DYING_END}function Ne(e,t){var r,n;return(null!=(r=e.percent)?r:0)-(null!=(n=t.percent)?n:0)}const fe=[exports.State.DASH,exports.State.TURN,exports.State.DASH];class Re{constructor(){this.playerPermutations=new Array,this.state=new Map}setup(e){this.state=new Map,this.playerPermutations=ce(e),this.playerPermutations.forEach((e=>{this.state.set(e,{playerCounts:{playerIndex:e.playerIndex,wavedashCount:0,wavelandCount:0,airDodgeCount:0,dashDanceCount:0,spotDodgeCount:0,ledgegrabCount:0,rollCount:0,lCancelCount:{success:0,fail:0},attackCount:{jab1:0,jab2:0,jab3:0,jabm:0,dash:0,ftilt:0,utilt:0,dtilt:0,fsmash:0,usmash:0,dsmash:0,nair:0,fair:0,bair:0,uair:0,dair:0},grabCount:{success:0,fail:0},throwCount:{up:0,forward:0,back:0,down:0},groundTechCount:{away:0,in:0,neutral:0,fail:0},wallTechCount:{success:0,fail:0}},animations:[],actionFrameCounters:[]})}))}processFrame(e){this.playerPermutations.forEach((t=>{const r=this.state.get(t);r&&function(e,t,r){const n=r.players[t.playerIndex].post,s=r.players[t.opponentIndex].post,a=(t,r)=>{if(!r)return;const n=F.default(e.playerCounts,t,0);G.default(e.playerCounts,t,n+1)},o=n.actionStateId;e.animations.push(o);const i=n.actionStateCounter;e.actionFrameCounters.push(i);const l=e.animations.slice(-3),E=l[l.length-2];if(!(o!==E||e.actionFrameCounters[e.actionFrameCounters.length-2]>i))return;var T;a("dashDanceCount",D.default(l,fe)),a("rollCount",(T=o)===exports.State.ROLL_BACKWARD||T===exports.State.ROLL_FORWARD),a("spotDodgeCount",o===exports.State.SPOT_DODGE),a("airDodgeCount",o===exports.State.AIR_DODGE),a("ledgegrabCount",o===exports.State.CLIFF_CATCH),a("grabCount.success",Ce(E)&&Ie(o)),a("grabCount.fail",Ce(E)&&!Ie(o)),o===exports.State.DASH_GRAB&&E===exports.State.ATTACK_DASH&&(e.playerCounts.attackCount.dash-=1),a("attackCount.jab1",o===exports.State.ATTACK_JAB1),a("attackCount.jab2",o===exports.State.ATTACK_JAB2),a("attackCount.jab3",o===exports.State.ATTACK_JAB3),a("attackCount.jabm",o===exports.State.ATTACK_JABM),a("attackCount.dash",o===exports.State.ATTACK_DASH),a("attackCount.ftilt",function(e){return e>=exports.State.ATTACK_FTILT_START&&e<=exports.State.ATTACK_FTILT_END}(o)),a("attackCount.utilt",o===exports.State.ATTACK_UTILT),a("attackCount.dtilt",o===exports.State.ATTACK_DTILT),a("attackCount.fsmash",function(e){return e>=exports.State.ATTACK_FSMASH_START&&e<=exports.State.ATTACK_FSMASH_END}(o)),a("attackCount.usmash",o===exports.State.ATTACK_USMASH),a("attackCount.dsmash",o===exports.State.ATTACK_DSMASH),a("attackCount.nair",o===exports.State.AERIAL_NAIR),a("attackCount.fair",o===exports.State.AERIAL_FAIR),a("attackCount.bair",o===exports.State.AERIAL_BAIR),a("attackCount.uair",o===exports.State.AERIAL_UAIR),a("attackCount.dair",o===exports.State.AERIAL_DAIR),24===n.internalCharacterId&&(a("attackCount.jab1",o===exports.State.GNW_JAB1),a("attackCount.jabm",o===exports.State.GNW_JABM),a("attackCount.dtilt",o===exports.State.GNW_DTILT),a("attackCount.fsmash",o===exports.State.GNW_FSMASH),a("attackCount.nair",o===exports.State.GNW_NAIR),a("attackCount.bair",o===exports.State.GNW_BAIR),a("attackCount.uair",o===exports.State.GNW_UAIR)),9===n.internalCharacterId&&(a("attackCount.fsmash",o===exports.State.PEACH_FSMASH1),a("attackCount.fsmash",o===exports.State.PEACH_FSMASH2),a("attackCount.fsmash",o===exports.State.PEACH_FSMASH3)),a("throwCount.up",o===exports.State.THROW_UP),a("throwCount.forward",o===exports.State.THROW_FORWARD),a("throwCount.down",o===exports.State.THROW_DOWN),a("throwCount.back",o===exports.State.THROW_BACK);const c=n.facingDirection===(n.positionX>s.positionX?-1:1);a("groundTechCount.fail",function(e){return e===exports.State.TECH_MISS_DOWN||e===exports.State.TECH_MISS_UP}(o)),a("groundTechCount.in",o===exports.State.FORWARD_TECH&&c),a("groundTechCount.in",o===exports.State.BACKWARD_TECH&&!c),a("groundTechCount.neutral",o===exports.State.NEUTRAL_TECH),a("groundTechCount.away",o===exports.State.BACKWARD_TECH&&c),a("groundTechCount.away",o===exports.State.FORWARD_TECH&&!c),a("wallTechCount.success",o===exports.State.WALL_TECH),a("wallTechCount.fail",o===exports.State.MISSED_WALL_TECH),function(e){return e>=exports.State.AERIAL_ATTACK_START&&e<=exports.State.AERIAL_ATTACK_END}(o)&&(a("lCancelCount.success",1===n.lCancelStatus),a("lCancelCount.fail",2===n.lCancelStatus)),function(e,t){const r=M.default(t)===exports.State.LANDING_FALL_SPECIAL,n=function(e){if(e===exports.State.AIR_DODGE)return!0;const t=e>=exports.State.CONTROLLED_JUMP_START,r=e<=exports.State.CONTROLLED_JUMP_END;return t&&r}(t[t.length-2]);if(!r||!n)return;const s=t.slice(-8),a=x.default(s,(e=>e));2===B.default(a)&&a[exports.State.AIR_DODGE]||(a[exports.State.AIR_DODGE]&&(e.airDodgeCount-=1),a[exports.State.ACTION_KNEE_BEND]?e.wavedashCount+=1:e.wavelandCount+=1)}(e.playerCounts,e.animations)}(r,t,e)}))}fetch(){return Array.from(this.state.values()).map((e=>e.playerCounts))}}function Ie(e){return e>exports.State.GRAB&&e<=exports.State.THROW_DOWN&&e!==exports.State.DASH_GRAB}function Ce(e){return e===exports.State.GRAB||e===exports.State.DASH_GRAB}var Oe,ge,Fe,De,xe,Me,Ge,Be,ye,Le;!function(e){e.COMBO_START="COMBO_START",e.COMBO_EXTEND="COMBO_EXTEND",e.COMBO_END="COMBO_END"}(Oe||(Oe={}));class Pe extends o.EventEmitter{constructor(...e){super(...e),this.playerPermutations=new Array,this.state=new Map,this.combos=new Array,this.settings=null}setup(e){this.settings=e,this.state=new Map,this.combos=[],this.playerPermutations=ce(e),this.playerPermutations.forEach((e=>{this.state.set(e,{combo:null,move:null,resetCounter:0,lastHitAnimation:null,event:null})}))}processFrame(e,t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&(function(e,t,r,n,s){const a=n.frame,o=n.players[r.playerIndex].post,i=n.players[r.opponentIndex].post,l=a-1;let E=null,T=null;e[l]&&(E=e[l].players[r.playerIndex].post,T=e[l].players[r.opponentIndex].post);const c=i.actionStateId,u=me(c),_=he(c),p=Se(c),A=T?Ne(i,T):0;if((o.actionStateId!==t.lastHitAnimation||o.actionStateCounter<(E?E.actionStateCounter:0))&&(t.lastHitAnimation=null),u||_||p){let e=!1;var m,h;t.combo||(t.combo={playerIndex:r.opponentIndex,startFrame:a,endFrame:null,startPercent:T&&null!=(m=T.percent)?m:0,currentPercent:null!=(h=i.percent)?h:0,endPercent:null,moves:[],didKill:!1,lastHitBy:r.playerIndex},s.push(t.combo),e=!0),A&&(null===t.lastHitAnimation&&(t.move={playerIndex:r.playerIndex,frame:a,moveId:o.lastAttackLanded,hitCount:0,damage:0},t.combo.moves.push(t.move),e||(t.event=Oe.COMBO_EXTEND)),t.move&&(t.move.hitCount+=1,t.move.damage+=A),t.lastHitAnimation=E?E.actionStateId:null),e&&(t.event=Oe.COMBO_START)}if(!t.combo)return;const S=pe(c),d=Ae(c),N=T&&ue(i,T),f=de(c);var R;N||(t.combo.currentPercent=null!=(R=i.percent)?R:0),u||_||p||S||d||f?t.resetCounter=0:t.resetCounter+=1;let I=!1;var C;N&&(t.combo.didKill=!0,I=!0),t.resetCounter>Te.COMBO_STRING_RESET_FRAMES&&(I=!0),I&&(t.combo.endFrame=o.frame,t.combo.endPercent=T&&null!=(C=T.percent)?C:0,t.event=Oe.COMBO_END,t.combo=null,t.move=null)}(t,n,r,e,this.combos),null!==n.event&&(this.emit(n.event,{combo:M.default(this.combos),settings:this.settings}),n.event=null))}))}fetch(){return this.combos}}class Ue extends o.EventEmitter{constructor(){super(),this.playerPermutations=new Array,this.conversions=new Array,this.state=new Map,this.metadata=void 0,this.settings=null,this.metadata={lastEndFrameByOppIdx:{}}}setup(e){this.playerPermutations=ce(e),this.conversions=[],this.state=new Map,this.metadata={lastEndFrameByOppIdx:{}},this.settings=e,this.playerPermutations.forEach((e=>{this.state.set(e,{conversion:null,move:null,resetCounter:0,lastHitAnimation:null})}))}processFrame(e,t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);if(n){const s=function(e,t,r,n,s){const a=n.frame,o=n.players[r.playerIndex].post,i=n.players[r.opponentIndex].post,l=a-1;let E=null,T=null;e[l]&&(E=e[l].players[r.playerIndex].post,T=e[l].players[r.opponentIndex].post);const c=i.actionStateId,u=me(c),_=he(c),p=Se(c),A=T?Ne(i,T):0;var m,h;if((o.actionStateId!==t.lastHitAnimation||o.actionStateCounter<(E?E.actionStateCounter:0))&&(t.lastHitAnimation=null),(u||_||p)&&(t.conversion||(t.conversion={playerIndex:r.opponentIndex,lastHitBy:r.playerIndex,startFrame:a,endFrame:null,startPercent:T&&null!=(m=T.percent)?m:0,currentPercent:null!=(h=i.percent)?h:0,endPercent:null,moves:[],didKill:!1,openingType:"unknown"},s.push(t.conversion)),A&&(null===t.lastHitAnimation&&(t.move={playerIndex:r.playerIndex,frame:a,moveId:o.lastAttackLanded,hitCount:0,damage:0},t.conversion.moves.push(t.move)),t.move&&(t.move.hitCount+=1,t.move.damage+=A),t.lastHitAnimation=E?E.actionStateId:null)),!t.conversion)return!1;const S=_e(c),d=T&&ue(i,T);var N;d||(t.conversion.currentPercent=null!=(N=i.percent)?N:0),(u||_||p)&&(t.resetCounter=0),(0===t.resetCounter&&S||t.resetCounter>0)&&(t.resetCounter+=1);let f=!1;var R;return d&&(t.conversion.didKill=!0,f=!0),t.resetCounter>Te.PUNISH_RESET_FRAMES&&(f=!0),f&&(t.conversion.endFrame=o.frame,t.conversion.endPercent=T&&null!=(R=T.percent)?R:0,t.conversion=null,t.move=null),f}(t,n,r,e,this.conversions);s&&this.emit("CONVERSION",{combo:M.default(this.conversions),settings:this.settings})}}))}fetch(){return this._populateConversionTypes(),this.conversions}_populateConversionTypes(){const e=y.default(this.conversions,(e=>"unknown"===e.openingType)),t=L.default(e,"startFrame");P.default(t,(e=>F.default(e,[0,"startFrame"]))).forEach((e=>{const t=e.length>=2;e.forEach((e=>{if(this.metadata.lastEndFrameByOppIdx[e.playerIndex]=e.endFrame,t)return void(e.openingType="trade");const r=M.default(e.moves),n=this.metadata.lastEndFrameByOppIdx[r?r.playerIndex:e.playerIndex];e.openingType=n&&n>e.startFrame?"counter-attack":"neutral-win"}))}))}}exports.Command=void 0,(ge=exports.Command||(exports.Command={}))[ge.SPLIT_MESSAGE=16]="SPLIT_MESSAGE",ge[ge.MESSAGE_SIZES=53]="MESSAGE_SIZES",ge[ge.GAME_START=54]="GAME_START",ge[ge.PRE_FRAME_UPDATE=55]="PRE_FRAME_UPDATE",ge[ge.POST_FRAME_UPDATE=56]="POST_FRAME_UPDATE",ge[ge.GAME_END=57]="GAME_END",ge[ge.FRAME_START=58]="FRAME_START",ge[ge.ITEM_UPDATE=59]="ITEM_UPDATE",ge[ge.FRAME_BOOKEND=60]="FRAME_BOOKEND",ge[ge.GECKO_LIST=61]="GECKO_LIST",exports.GameMode=void 0,(Fe=exports.GameMode||(exports.GameMode={}))[Fe.VS=2]="VS",Fe[Fe.ONLINE=8]="ONLINE",Fe[Fe.TARGET_TEST=15]="TARGET_TEST",Fe[Fe.HOME_RUN_CONTEST=32]="HOME_RUN_CONTEST",exports.Language=void 0,(De=exports.Language||(exports.Language={}))[De.JAPANESE=0]="JAPANESE",De[De.ENGLISH=1]="ENGLISH",exports.TimerType=void 0,(xe=exports.TimerType||(exports.TimerType={}))[xe.NONE=0]="NONE",xe[xe.DECREASING=2]="DECREASING",xe[xe.INCREASING=3]="INCREASING",exports.ItemSpawnType=void 0,(Me=exports.ItemSpawnType||(exports.ItemSpawnType={}))[Me.OFF=255]="OFF",Me[Me.VERY_LOW=0]="VERY_LOW",Me[Me.LOW=1]="LOW",Me[Me.MEDIUM=2]="MEDIUM",Me[Me.HIGH=3]="HIGH",Me[Me.VERY_HIGH=4]="VERY_HIGH",exports.EnabledItemType=void 0,(Ge=exports.EnabledItemType||(exports.EnabledItemType={}))[Ge.METAL_BOX=1]="METAL_BOX",Ge[Ge.CLOAKING_DEVICE=2]="CLOAKING_DEVICE",Ge[Ge.POKEBALL=4]="POKEBALL",Ge[Ge.UNKNOWN_ITEM_BIT_4=8]="UNKNOWN_ITEM_BIT_4",Ge[Ge.UNKNOWN_ITEM_BIT_5=16]="UNKNOWN_ITEM_BIT_5",Ge[Ge.UNKNOWN_ITEM_BIT_6=32]="UNKNOWN_ITEM_BIT_6",Ge[Ge.UNKNOWN_ITEM_BIT_7=64]="UNKNOWN_ITEM_BIT_7",Ge[Ge.UNKNOWN_ITEM_BIT_8=128]="UNKNOWN_ITEM_BIT_8",Ge[Ge.FAN=256]="FAN",Ge[Ge.FIRE_FLOWER=512]="FIRE_FLOWER",Ge[Ge.SUPER_MUSHROOM=1024]="SUPER_MUSHROOM",Ge[Ge.POISON_MUSHROOM=2048]="POISON_MUSHROOM",Ge[Ge.HAMMER=4096]="HAMMER",Ge[Ge.WARP_STAR=8192]="WARP_STAR",Ge[Ge.SCREW_ATTACK=16384]="SCREW_ATTACK",Ge[Ge.BUNNY_HOOD=32768]="BUNNY_HOOD",Ge[Ge.RAY_GUN=65536]="RAY_GUN",Ge[Ge.FREEZIE=131072]="FREEZIE",Ge[Ge.FOOD=262144]="FOOD",Ge[Ge.MOTION_SENSOR_BOMB=524288]="MOTION_SENSOR_BOMB",Ge[Ge.FLIPPER=1048576]="FLIPPER",Ge[Ge.SUPER_SCOPE=2097152]="SUPER_SCOPE",Ge[Ge.STAR_ROD=4194304]="STAR_ROD",Ge[Ge.LIPS_STICK=8388608]="LIPS_STICK",Ge[Ge.HEART_CONTAINER=16777216]="HEART_CONTAINER",Ge[Ge.MAXIM_TOMATO=33554432]="MAXIM_TOMATO",Ge[Ge.STARMAN=67108864]="STARMAN",Ge[Ge.HOME_RUN_BAT=134217728]="HOME_RUN_BAT",Ge[Ge.BEAM_SWORD=268435456]="BEAM_SWORD",Ge[Ge.PARASOL=536870912]="PARASOL",Ge[Ge.GREEN_SHELL=1073741824]="GREEN_SHELL",Ge[Ge.RED_SHELL=2147483648]="RED_SHELL",Ge[Ge.CAPSULE=4294967296]="CAPSULE",Ge[Ge.BOX=8589934592]="BOX",Ge[Ge.BARREL=17179869184]="BARREL",Ge[Ge.EGG=34359738368]="EGG",Ge[Ge.PARTY_BALL=68719476736]="PARTY_BALL",Ge[Ge.BARREL_CANNON=137438953472]="BARREL_CANNON",Ge[Ge.BOMB_OMB=274877906944]="BOMB_OMB",Ge[Ge.MR_SATURN=549755813888]="MR_SATURN",exports.GameEndMethod=void 0,(Be=exports.GameEndMethod||(exports.GameEndMethod={}))[Be.UNRESOLVED=0]="UNRESOLVED",Be[Be.RESOLVED=3]="RESOLVED",Be[Be.TIME=1]="TIME",Be[Be.GAME=2]="GAME",Be[Be.NO_CONTEST=7]="NO_CONTEST",exports.Frames=void 0,(ye=exports.Frames||(exports.Frames={}))[ye.FIRST=-123]="FIRST",ye[ye.FIRST_PLAYABLE=-39]="FIRST_PLAYABLE",function(e){e[e.DZ=0]="DZ",e[e.NE=1]="NE",e[e.SE=2]="SE",e[e.SW=3]="SW",e[e.NW=4]="NW",e[e.N=5]="N",e[e.E=6]="E",e[e.S=7]="S",e[e.W=8]="W"}(Le||(Le={}));class He{constructor(){this.state=new Map,this.playerPermutations=new Array}setup(e){this.state=new Map,this.playerPermutations=ce(e),this.playerPermutations.forEach((e=>{this.state.set(e,{playerIndex:e.playerIndex,opponentIndex:e.opponentIndex,inputCount:0,joystickInputCount:0,cstickInputCount:0,buttonInputCount:0,triggerInputCount:0})}))}processFrame(e,t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(e,t,r,n){const s=n.players[r.playerIndex].pre,a=s.frame,o=a-1,i=e[o]?e[o].players[r.playerIndex].pre:null;if(a<exports.Frames.FIRST_PLAYABLE||!i)return;const l=function(e){let t,r=e;for(t=0;r;t+=1)r&=r-1;return t}(~i.physicalButtons&s.physicalButtons&4095);t.inputCount+=l,t.buttonInputCount+=l;const E=ve(i.joystickX,i.joystickY),T=ve(s.joystickX,s.joystickY);E!==T&&T!==Le.DZ&&(t.inputCount+=1,t.joystickInputCount+=1);const c=ve(i.cStickX,i.cStickY),u=ve(s.cStickX,s.cStickY);c!==u&&u!==Le.DZ&&(t.inputCount+=1,t.cstickInputCount+=1),i.physicalLTrigger<.3&&s.physicalLTrigger>=.3&&(t.inputCount+=1,t.triggerInputCount+=1),i.physicalRTrigger<.3&&s.physicalRTrigger>=.3&&(t.inputCount+=1,t.triggerInputCount+=1)}(t,n,r,e)}))}fetch(){return Array.from(this.state.values())}}function ve(e,t){let r=Le.DZ;return e>=.2875&&t>=.2875?r=Le.NE:e>=.2875&&t<=-.2875?r=Le.SE:e<=-.2875&&t<=-.2875?r=Le.SW:e<=-.2875&&t>=.2875?r=Le.NW:t>=.2875?r=Le.N:e>=.2875?r=Le.E:t<=-.2875?r=Le.S:e<=-.2875&&(r=Le.W),r}function we({settings:e,inputs:t,conversions:r,playableFrameCount:n}){const s=x.default(t,"playerIndex"),a=r,o=L.default(r,(e=>{var t;return null==(t=e.moves[0])?void 0:t.playerIndex})),i=v.default(o,(e=>L.default(e,"openingType"))),l=n/3600;return e.players.map((t=>{const r=t.playerIndex,n=F.default(s,r)||{},o={buttons:F.default(n,"buttonInputCount"),triggers:F.default(n,"triggerInputCount"),cstick:F.default(n,"cstickInputCount"),joystick:F.default(n,"joystickInputCount"),total:F.default(n,"inputCount")};let E=0,T=0;const c=e.players.filter((n=>n.playerIndex!==r&&(!e.isTeams||n.teamId!==t.teamId))).map((e=>e.playerIndex));let u=0,_=0;return a.filter((e=>e.playerIndex!==r)).forEach((e=>{E++,e.didKill&&e.lastHitBy===r&&(_+=1),e.moves.length>1&&e.moves[0].playerIndex===r&&T++,e.moves.forEach((e=>{e.playerIndex===r&&(u+=e.damage)}))})),{playerIndex:r,inputCounts:o,conversionCount:E,totalDamage:u,killCount:_,successfulConversions:ke(T,E),inputsPerMinute:ke(o.total,l),digitalInputsPerMinute:ke(o.buttons,l),openingsPerKill:ke(E,_),damagePerOpening:ke(u,E),neutralWinRatio:We(i,r,c,"neutral-win"),counterHitRatio:We(i,r,c,"counter-attack"),beneficialTradeRatio:Ve(i,r,c)}}))}function ke(e,t){return{count:e,total:t,ratio:t?e/t:null}}function We(e,t,r,n){const s=F.default(e,[t,n])||[],a=H.default(r.map((t=>F.default(e,[t,n])||[])));return ke(s.length,s.length+a.length)}function Ve(e,t,r){const n=F.default(e,[t,"trade"])||[],s=H.default(r.map((t=>F.default(e,[t,"trade"])||[]))),a=[];return w.default(n,s).forEach((e=>{const t=U.default(e),r=M.default(e);if(t&&r){const e=t.currentPercent-t.startPercent,n=r.currentPercent-r.startPercent;(t.didKill&&!r.didKill||e>n)&&a.push(t)}})),ke(a.length,n.length)}const be={processOnTheFly:!1};class Ye{constructor(e){this.options=void 0,this.lastProcessedFrame=null,this.frames={},this.players=[],this.allComputers=new Array,this.options=Object.assign({},be,e)}setup(e){this.frames={},this.players=e.players.map((e=>e.playerIndex)),this.allComputers.forEach((t=>t.setup(e)))}register(...e){this.allComputers.push(...e)}process(){if(0===this.players.length)return;let e=null!==this.lastProcessedFrame?this.lastProcessedFrame+1:exports.Frames.FIRST;for(;this.frames[e];){const t=this.frames[e];if(!Ke(this.players,t))return;this.allComputers.forEach((e=>e.processFrame(t,this.frames))),this.lastProcessedFrame=e,e++}}addFrame(e){this.frames[e.frame]=e,this.options.processOnTheFly&&this.process()}}function Ke(e,t){if(!t)return!1;for(const r of e)if(!F.default(t,["players",r,"post"]))return!1;return!0}class Je{constructor(){this.state=new Map,this.playerPermutations=new Array,this.stocks=new Array}setup(e){this.state=new Map,this.playerPermutations=ce(e),this.stocks=[],this.playerPermutations.forEach((e=>{this.state.set(e,{stock:null})}))}processFrame(e,t){this.playerPermutations.forEach((r=>{const n=this.state.get(r);n&&function(e,t,r,n,s){const a=n.players[r.playerIndex].post,o=a.frame,i=o-1,l=e[i]?e[i].players[r.playerIndex].post:null;if(t.stock)if(l&&ue(a,l)){var E;t.stock.endFrame=a.frame,t.stock.endPercent=null!=(E=l.percent)?E:0,t.stock.deathAnimation=a.actionStateId,t.stock=null}else{var T;t.stock.currentPercent=null!=(T=a.percent)?T:0}else{if(de(a.actionStateId))return;t.stock={playerIndex:r.playerIndex,startFrame:o,endFrame:null,startPercent:0,endPercent:null,currentPercent:0,count:a.stocksRemaining,deathAnimation:null},s.push(t.stock)}}(t,n,r,e,this.stocks)}))}fetch(){return this.stocks}}function Xe(e){return null!=e}class je{constructor(){this.targetBreaks=new Array,this.isTargetTestGame=!1}setup(e){this.targetBreaks=[],this.isTargetTestGame=e.gameMode===exports.GameMode.TARGET_TEST}processFrame(e,t){this.isTargetTestGame&&function(e,t,r){var n,s,a,o,i,l;const E=t.frame,T=E-1;var c,u,_;E===exports.Frames.FIRST&&(null!=(c=null==(u=e[exports.Frames.FIRST])||null==(_=u.items)?void 0:_.filter((e=>209===e.typeId)))?c:[]).forEach((e=>{r.push({spawnId:e.spawnId,frameDestroyed:null,positionX:e.positionX,positionY:e.positionY})}));const p=null!=(n=null==(s=e[E])||null==(a=s.items)?void 0:a.filter((e=>209===e.typeId)))?n:[],A=null!=(o=null==(i=e[T])||null==(l=i.items)?void 0:l.filter((e=>209===e.typeId)))?o:[],m=p.map((e=>e.spawnId)).filter(Xe);A.map((e=>e.spawnId)).filter(Xe).filter((e=>!m.includes(e))).forEach((e=>{const t=r.find((t=>t.spawnId===e));t&&(t.frameDestroyed=E)}))}(t,e,this.targetBreaks)}fetch(){return this.targetBreaks}}var ze,$e,qe,Ze,Qe;exports.CommunicationType=void 0,(ze=exports.CommunicationType||(exports.CommunicationType={}))[ze.HANDSHAKE=1]="HANDSHAKE",ze[ze.REPLAY=2]="REPLAY",ze[ze.KEEP_ALIVE=3]="KEEP_ALIVE";class et{constructor(){this.receiveBuf=Buffer.from([]),this.messages=new Array}receive(e){for(this.receiveBuf=Buffer.concat([this.receiveBuf,e]);this.receiveBuf.length>=4;){const e=this.receiveBuf.readUInt32BE(0);if(this.receiveBuf.length<e+4)return;const t=this.receiveBuf.slice(4,e+4);this.messages.push(S.decode(t)),this.receiveBuf=this.receiveBuf.slice(e+4)}}getReceiveBuffer(){return this.receiveBuf}getMessages(){const e=this.messages;return this.messages=[],e}genHandshakeOut(e,t,r=!1){const n=Buffer.from([0,0,0,0]);n.writeUInt32BE(t,0);const s={type:exports.CommunicationType.HANDSHAKE,payload:{cursor:e,clientToken:Uint8Array.from(n),isRealtime:r}},a=S.encode(s,{optimizeArrays:!0}),o=Buffer.concat([Buffer.from([0,0,0,0]),Buffer.from(a)]);return o.writeUInt32BE(a.byteLength,0),o}}exports.ConnectionEvent=void 0,($e=exports.ConnectionEvent||(exports.ConnectionEvent={})).CONNECT="connect",$e.MESSAGE="message",$e.HANDSHAKE="handshake",$e.STATUS_CHANGE="statusChange",$e.DATA="data",$e.ERROR="error",exports.ConnectionStatus=void 0,(qe=exports.ConnectionStatus||(exports.ConnectionStatus={}))[qe.DISCONNECTED=0]="DISCONNECTED",qe[qe.CONNECTING=1]="CONNECTING",qe[qe.CONNECTED=2]="CONNECTED",qe[qe.RECONNECT_WAIT=3]="RECONNECT_WAIT",exports.Ports=void 0,(Ze=exports.Ports||(exports.Ports={}))[Ze.DEFAULT=51441]="DEFAULT",Ze[Ze.LEGACY=666]="LEGACY",Ze[Ze.RELAY_START=53741]="RELAY_START",function(e){e.INITIAL="initial",e.LEGACY="legacy",e.NORMAL="normal"}(Qe||(Qe={}));const tt={consoleNick:"unknown",gameDataCursor:Uint8Array.from([0,0,0,0,0,0,0,0]),version:"",clientToken:0},rt={autoReconnect:!0};var nt,st,at;function ot(e){const t=K.default(e,(e=>{return(t=e.charCodeAt(0))>65280&&t<65375?t-65280+32:12288===t?32:8217===t?39:8221===t?34:t;var t}));return String.fromCharCode(...t)}function it(e,t,r,n,s){switch(e.source){case exports.SlpInputSource.FILE:return k.default.readSync(e.fileDescriptor,t,r,n,s);case exports.SlpInputSource.BUFFER:return s>=e.buffer.length?0:e.buffer.copy(t,r,s,s+n);default:throw new Error("Source type not supported")}}function lt(e){switch(e.source){case exports.SlpInputSource.FILE:return k.default.fstatSync(e.fileDescriptor).size;case exports.SlpInputSource.BUFFER:return e.buffer.length;default:throw new Error("Source type not supported")}}function Et(e){const t=function(e){switch(e.source){case exports.SlpInputSource.FILE:if(!e.filePath)throw new Error("File source requires a file path");const t=k.default.openSync(e.filePath,"r");return{source:e.source,fileDescriptor:t};case exports.SlpInputSource.BUFFER:return{source:e.source,buffer:e.buffer};default:throw new Error("Source type not supported")}}(e),r=function(e){const t=new Uint8Array(1);return it(e,t,0,t.length,0),54===t[0]||t[0]!=="{".charCodeAt(0)?0:15}(t),n=function(e,t){const r=lt(e);if(0===t)return r;const n=new Uint8Array(4);it(e,n,0,n.length,t-4);const s=n[0]<<24|n[1]<<16|n[2]<<8|n[3];return s>0?s:r-t}(t,r),s=r+n+10,a=function(e,t){return lt(e)-t-1}(t,s),o=function(e,t){const r={};if(0===t)return r[54]=320,r[55]=6,r[56]=70,r[57]=1,r;const n=new Uint8Array(2);if(it(e,n,0,n.length,t),n[0]!==exports.Command.MESSAGE_SIZES)return{};const s=n[1];r[53]=s;const a=new Uint8Array(s-1);it(e,a,0,a.length,t+2);for(let e=0;e<s-1;e+=3)r[a[e]]=a[e+1]<<8|a[e+2];return r}(t,r);return{ref:t,rawDataPosition:r,rawDataLength:n,metadataPosition:s,metadataLength:a,messageSizes:o}}function Tt(e){e.ref.source===exports.SlpInputSource.FILE&&k.default.closeSync(e.ref.fileDescriptor)}function ct(e){return[1,256,65536,16777216,4294967296].reduce(((t,r,n)=>t+ft(e,40+n)*r),0)}function ut(e){return{gameBitfield1:ft(e,5),gameBitfield2:ft(e,6),gameBitfield3:ft(e,7),gameBitfield4:ft(e,8),bombRainEnabled:(255&ft(e,11))>0,selfDestructScoreValue:St(e,17),itemSpawnBitfield1:ft(e,40),itemSpawnBitfield2:ft(e,41),itemSpawnBitfield3:ft(e,42),itemSpawnBitfield4:ft(e,43),itemSpawnBitfield5:ft(e,44),damageRatio:mt(e,53)}}function _t(e,t,r=null){const n=e.ref;let s=null!==r&&r>0?r:e.rawDataPosition;const a=e.rawDataPosition+e.rawDataLength,o=v.default(e.messageSizes,(e=>new Uint8Array(e+1)));let i=new Uint8Array(0);const l=new Uint8Array(1);for(;s<a;){var E;it(n,l,0,1,s);let e=null!=(E=l[0])?E:0,r=o[e];if(void 0===r)return s;if(r.length>a-s)return s;const _=r.length;if(it(n,r,0,r.length,s),e===exports.Command.SPLIT_MESSAGE){var T,c;const t=new DataView(r.buffer),n=null!=(T=Nt(t,513))?T:512,s=Rt(t,516),a=null!=(c=ft(t,515))?c:0;0===i.length&&(i=new Uint8Array(1),i[0]=a);const o=r.slice(1,1+n),l=new Uint8Array(i.length+o.length);var u;l.set(i),l.set(o,i.length),i=l,s&&(e=null!=(u=i[0])?u:0,r=i,i=new Uint8Array(0))}if(t(e,pt(e,r),r))break;s+=_}return s}function pt(e,t){const r=new DataView(t.buffer);switch(e){case exports.Command.GAME_START:const e=e=>{const n=8*e,s=dt(r,321+n);let a="None";s!==dt(r,325+n)?a="Mixed":1===s?a="UCF":2===s&&(a="Dween");const o=353+16*e,i=t.slice(o,o+16),l=Y.default.decode(i,"Shift_JIS").split("\0").shift(),E=l?ot(l):"",T=421+31*e,c=t.slice(T,T+31),u=Y.default.decode(c,"Shift_JIS").split("\0").shift(),_=u?ot(u):"",p=545+10*e,A=t.slice(p,p+10),m=Y.default.decode(A,"Shift_JIS").split("\0").shift(),h=m?ot(m):"",S=585+29*e,d=t.slice(S,S+29),N=Y.default.decode(d,"utf8").split("\0").shift(),f=null!=N?N:"",R=36*e;return{playerIndex:e,port:e+1,characterId:ft(r,101+R),type:ft(r,102+R),startStocks:ft(r,103+R),characterColor:ft(r,104+R),teamShade:ft(r,108+R),handicap:ft(r,109+R),teamId:ft(r,110+R),staminaMode:Boolean(ft(r,108+36*e,1)),silentCharacter:Boolean(ft(r,108+36*e,2)),lowGravity:Boolean(ft(r,108+36*e,4)),invisible:Boolean(ft(r,108+36*e,8)),blackStockIcon:Boolean(ft(r,108+36*e,16)),metal:Boolean(ft(r,108+36*e,32)),startOnAngelPlatform:Boolean(ft(r,108+36*e,64)),rumbleEnabled:Boolean(ft(r,108+36*e,128)),cpuLevel:ft(r,116+R),offenseRatio:mt(r,125+R),defenseRatio:mt(r,129+R),modelScale:mt(r,133+R),controllerFix:a,nametag:E,displayName:_,connectCode:h,userId:f}},o=702,i=t.slice(o,o+51),l=Y.default.decode(i,"utf8").split("\0").shift(),E=null!=l?l:"";return{slpVersion:`${ft(r,1)}.${ft(r,2)}.${ft(r,3)}`,timerType:ft(r,5,3),inGameMode:ft(r,5,224),friendlyFireEnabled:!!ft(r,6,1),isTeams:Rt(r,13),itemSpawnBehavior:ft(r,16),stageId:Nt(r,19),startingTimerSeconds:dt(r,21),enabledItems:ct(r),players:[0,1,2,3].map(e),scene:ft(r,419),gameMode:ft(r,420),language:ft(r,701),gameInfoBlock:ut(r),randomSeed:dt(r,317),isPAL:Rt(r,417),isFrozenPS:Rt(r,418),matchInfo:{matchId:E,gameNumber:dt(r,753),tiebreakerNumber:dt(r,757)}};case exports.Command.FRAME_START:return{frame:ht(r,1),seed:dt(r,5),sceneFrameCounter:dt(r,9)};case exports.Command.PRE_FRAME_UPDATE:return{frame:ht(r,1),playerIndex:ft(r,5),isFollower:Rt(r,6),seed:dt(r,7),actionStateId:Nt(r,11),positionX:mt(r,13),positionY:mt(r,17),facingDirection:mt(r,21),joystickX:mt(r,25),joystickY:mt(r,29),cStickX:mt(r,33),cStickY:mt(r,37),trigger:mt(r,41),buttons:dt(r,45),physicalButtons:Nt(r,49),physicalLTrigger:mt(r,51),physicalRTrigger:mt(r,55),rawJoystickX:St(r,59),percent:mt(r,60)};case exports.Command.POST_FRAME_UPDATE:const T={airX:mt(r,53),y:mt(r,57),attackX:mt(r,61),attackY:mt(r,65),groundX:mt(r,69)};return{frame:ht(r,1),playerIndex:ft(r,5),isFollower:Rt(r,6),internalCharacterId:ft(r,7),actionStateId:Nt(r,8),positionX:mt(r,10),positionY:mt(r,14),facingDirection:mt(r,18),percent:mt(r,22),shieldSize:mt(r,26),lastAttackLanded:ft(r,30),currentComboCount:ft(r,31),lastHitBy:ft(r,32),stocksRemaining:ft(r,33),actionStateCounter:mt(r,34),miscActionState:mt(r,43),isAirborne:Rt(r,47),lastGroundId:Nt(r,48),jumpsRemaining:ft(r,50),lCancelStatus:ft(r,51),hurtboxCollisionState:ft(r,52),selfInducedSpeeds:T,hitlagRemaining:mt(r,73),animationIndex:dt(r,77),instanceHitBy:Nt(r,81),instanceId:Nt(r,83)};case exports.Command.ITEM_UPDATE:return{frame:ht(r,1),typeId:Nt(r,5),state:ft(r,7),facingDirection:mt(r,8),velocityX:mt(r,12),velocityY:mt(r,16),positionX:mt(r,20),positionY:mt(r,24),damageTaken:Nt(r,28),expirationTimer:mt(r,30),spawnId:dt(r,34),missileType:ft(r,38),turnipFace:ft(r,39),chargeShotLaunched:ft(r,40),chargePower:ft(r,41),owner:St(r,42),instanceId:Nt(r,43)};case exports.Command.FRAME_BOOKEND:return{frame:ht(r,1),latestFinalizedFrame:ht(r,5)};case exports.Command.GAME_END:const c=[0,1,2,3].map((e=>({playerIndex:e,position:St(r,3+e)})));return{gameEndMethod:ft(r,1),lrasInitiatorIndex:St(r,2),placements:c};case exports.Command.GECKO_LIST:const u=[];let _=1;for(;_<t.length;){var n;const e=null!=(n=dt(r,_))?n:0,o=e>>24&254,i=2147483648+(33554431&e);let l=8;var s;if(192===o||194===o)l=8+8*(null!=(s=dt(r,_+4))?s:0);else if(6===o){var a;l=8+((null!=(a=dt(r,_+4))?a:0)+7&4294967288)}else 8===o&&(l=16);u.push({type:o,address:i,contents:t.slice(_,_+l)}),_+=l}return{contents:t.slice(1),codes:u};default:return null}}function At(e,t,r){return t+r<=e.byteLength}function mt(e,t){return At(e,t,4)?e.getFloat32(t):null}function ht(e,t){return At(e,t,4)?e.getInt32(t):null}function St(e,t){return At(e,t,1)?e.getInt8(t):null}function dt(e,t){return At(e,t,4)?e.getUint32(t):null}function Nt(e,t){return At(e,t,2)?e.getUint16(t):null}function ft(e,t,r=255){return At(e,t,1)?e.getUint8(t)&r:null}function Rt(e,t){return At(e,t,1)?!!e.getUint8(t):null}function It(e){if(e.metadataLength<=0)return null;const t=new Uint8Array(e.metadataLength);it(e.ref,t,0,t.length,e.metadataPosition);let r=null;try{r=S.decode(t)}catch(e){}return r}function Ct(e){const{ref:t,rawDataPosition:r,rawDataLength:n,messageSizes:s}=e,a=s[exports.Command.GAME_END];if(!Xe(a)||a<=0)return null;const o=a+1,i=r+n-o,l=new Uint8Array(o);return it(t,l,0,l.length,i),l[0]!==exports.Command.GAME_END?null:pt(exports.Command.GAME_END,l)||null}function Ot(e){const{ref:t,rawDataPosition:r,rawDataLength:n,messageSizes:s}=e,a=s[exports.Command.POST_FRAME_UPDATE],o=s[exports.Command.GAME_END],i=s[exports.Command.FRAME_BOOKEND];if(!Xe(a))return[];const l=a+1;let E=null,T=r+n-(o?o+1:0)-(i?i+1:0)-l;const c=[];do{const e=new Uint8Array(l);if(it(t,e,0,e.length,T),e[0]!==exports.Command.POST_FRAME_UPDATE)break;const r=pt(exports.Command.POST_FRAME_UPDATE,e);if(!r)break;if(null===E)E=r.frame;else if(E!==r.frame)break;c.unshift(r),T-=l}while(T>=r);return c}exports.DolphinMessageType=void 0,(nt=exports.DolphinMessageType||(exports.DolphinMessageType={})).CONNECT_REPLY="connect_reply",nt.GAME_EVENT="game_event",nt.START_GAME="start_game",nt.END_GAME="end_game",exports.SlpInputSource=void 0,(st=exports.SlpInputSource||(exports.SlpInputSource={})).BUFFER="buffer",st.FILE="file",exports.SlpStreamMode=void 0,(at=exports.SlpStreamMode||(exports.SlpStreamMode={})).AUTO="AUTO",at.MANUAL="MANUAL";const gt={suppressErrors:!1,mode:exports.SlpStreamMode.AUTO};var Ft;exports.SlpStreamEvent=void 0,(Ft=exports.SlpStreamEvent||(exports.SlpStreamEvent={})).RAW="slp-raw",Ft.COMMAND="slp-command";class Dt extends h.Writable{constructor(e,t){super(t),this.gameEnded=!1,this.settings=void 0,this.payloadSizes=null,this.previousBuffer=Buffer.from([]),this.settings=Object.assign({},gt,e)}restart(){this.gameEnded=!1,this.payloadSizes=null}_write(e,t,r){if("buffer"!==t)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${t}'.`);const n=Uint8Array.from(Buffer.concat([this.previousBuffer,e]));this.previousBuffer=Buffer.from([]);const s=new DataView(n.buffer);let a=0;for(;a<n.length;){if("HELO\0"===Buffer.from(n.slice(a,a+5)).toString()){a+=5;continue}const e=s.getUint8(a);let t=0;var o;if(this.payloadSizes&&(t=null!=(o=this.payloadSizes.get(e))?o:0),n.length-a<t+1){this.previousBuffer=n.slice(a);break}if(this.settings.mode===exports.SlpStreamMode.MANUAL&&this.gameEnded)break;a+=1;const r=n.slice(a),i=new DataView(n.buffer,a);let l=0;try{l=this._processCommand(e,r,i)}catch(e){if(!this.settings.suppressErrors)throw e;l=0}a+=l}r()}_writeCommand(e,t,r){const n=t.slice(0,r),s=Buffer.concat([Buffer.from([e]),n]);return this.emit(exports.SlpStreamEvent.RAW,{command:e,payload:s}),new Uint8Array(s)}_processCommand(e,t,r){if(e===exports.Command.MESSAGE_SIZES){const n=r.getUint8(0);return this.payloadSizes=xt(r),this._writeCommand(e,t,n),this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:this.payloadSizes}),n}let n=0;var s;this.payloadSizes&&(n=null!=(s=this.payloadSizes.get(e))?s:0);let a,o=null;return n>0&&(a=this._writeCommand(e,t,n),o=pt(e,a)),o?(e===exports.Command.GAME_END&&this.settings.mode===exports.SlpStreamMode.MANUAL&&(this.gameEnded=!0),this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:o}),n):n}}const xt=e=>{const t=new Map,r=e.getUint8(0);for(let n=1;n<r;n+=3){const r=e.getUint8(n),s=e.getUint16(n+1);t.set(r,s)}return t};class Mt extends h.Writable{constructor(e,t,r){super(r),this.filePath=void 0,this.metadata=void 0,this.fileStream=null,this.rawDataLength=0,this.slpStream=void 0,this.usesExternalStream=!1,this.filePath=e,this.metadata={consoleNickname:"unknown",startTime:new Date,lastFrame:-124,players:{}},this.usesExternalStream=Boolean(t),this.slpStream=t||new Dt({mode:exports.SlpStreamMode.MANUAL}),this._setupListeners(),this._initializeNewGame(this.filePath)}path(){return this.filePath}setMetadata(e){this.metadata=Object.assign({},this.metadata,e)}_write(e,t,r){if("buffer"!==t)throw new Error(`Unsupported stream encoding. Expected 'buffer' got '${t}'.`);this.fileStream&&this.fileStream.write(e),this.usesExternalStream||this.slpStream.write(e),this.rawDataLength+=e.length,r()}_onCommand(e){const{command:t,payload:r}=e;switch(t){case exports.Command.GAME_START:const{players:e}=r;W.default(e,(e=>{3!==e.type&&(this.metadata.players[e.playerIndex]={characterUsage:{},names:{netplay:e.displayName,code:e.connectCode}})}));break;case exports.Command.POST_FRAME_UPDATE:const{frame:t,playerIndex:n,isFollower:s,internalCharacterId:a}=r;if(s)break;this.metadata.lastFrame=t;const o=this.metadata.players[n],i=o.characterUsage,l=i[a]||0,E={...o,characterUsage:{...i,[a]:l+1}};this.metadata.players[n]=E}}_setupListeners(){const e=e=>{this._onCommand(e)};this.slpStream.on(exports.SlpStreamEvent.COMMAND,e),this.on("finish",(()=>{const t=k.default.openSync(this.filePath,"r+");k.default.writeSync(t,Bt(this.rawDataLength),0,4,11),k.default.closeSync(t),this.slpStream.removeListener(exports.SlpStreamEvent.COMMAND,e),this.usesExternalStream||this.slpStream.end()}))}_initializeNewGame(e){this.fileStream=k.default.createWriteStream(e,{encoding:"binary"});const t=Buffer.concat([Buffer.from("{U"),Buffer.from([3]),Buffer.from("raw[$U#l"),Buffer.from([0,0,0,0])]);this.fileStream.write(t)}_final(e){let t=Buffer.concat([Buffer.from("U"),Buffer.from([8]),Buffer.from("metadata{")]);const r=this.metadata.startTime.toISOString();t=Buffer.concat([t,Buffer.from("U"),Buffer.from([7]),Buffer.from("startAtSU"),Buffer.from([r.length]),Buffer.from(r)]);const n=this.metadata.lastFrame;t=Buffer.concat([t,Buffer.from("U"),Buffer.from([9]),Buffer.from("lastFramel"),Gt(n)]);const s=this.metadata.consoleNickname||"unknown";t=Buffer.concat([t,Buffer.from("U"),Buffer.from([11]),Buffer.from("consoleNickSU"),Buffer.from([s.length]),Buffer.from(s)]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([7]),Buffer.from("players{")]),W.default(this.metadata.players,((e,r)=>{t=Buffer.concat([t,Buffer.from("U"),Buffer.from([r.length]),Buffer.from(`${r}{`)]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([10]),Buffer.from("characters{")]),W.default(e.characterUsage,((e,r)=>{t=Buffer.concat([t,Buffer.from("U"),Buffer.from([r.length]),Buffer.from(`${r}l`),Bt(e)])})),t=Buffer.concat([t,Buffer.from("}")]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([5]),Buffer.from("names{")]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([7]),Buffer.from("netplaySU"),Buffer.from([e.names.netplay.length]),Buffer.from(`${e.names.netplay}`)]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([4]),Buffer.from("codeSU"),Buffer.from([e.names.code.length]),Buffer.from(`${e.names.code}`)]),t=Buffer.concat([t,Buffer.from("}}")])})),t=Buffer.concat([t,Buffer.from("}")]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([8]),Buffer.from("playedOnSU"),Buffer.from([7]),Buffer.from("network")]),t=Buffer.concat([t,Buffer.from("}}")]),this.fileStream&&this.fileStream.write(t,e)}}const Gt=e=>{const t=Buffer.alloc(4);return t.writeInt32BE(e,0),t},Bt=e=>{const t=Buffer.alloc(4);return t.writeUInt32BE(e,0),t},yt={outputFiles:!0,folderPath:".",consoleNickname:"unknown",newFilename:function(e,t){return J.default.join(e,`Game_${p.format(t,"yyyyMMdd")}T${p.format(t,"HHmmss")}.slp`)}};var Lt,Pt;exports.SlpFileWriterEvent=void 0,(Lt=exports.SlpFileWriterEvent||(exports.SlpFileWriterEvent={})).NEW_FILE="new-file",Lt.FILE_COMPLETE="file-complete";class Ut{constructor(){this.rollbackFrames={},this.rollbackFrameCount=0,this.rollbackPlayerIdx=null,this.lastFrameWasRollback=!1,this.currentRollbackLength=0,this.rollbackLengths=[]}checkIfRollbackFrame(e,t){if(null===this.rollbackPlayerIdx)this.rollbackPlayerIdx=t;else if(this.rollbackPlayerIdx!==t)return;return e&&e.players?(this.rollbackFrames[e.frame]?this.rollbackFrames[e.frame].push(e):this.rollbackFrames[e.frame]=[e],this.rollbackFrameCount++,this.currentRollbackLength++,this.lastFrameWasRollback=!0):this.lastFrameWasRollback&&(this.rollbackLengths.push(this.currentRollbackLength),this.currentRollbackLength=0,this.lastFrameWasRollback=!1),this.lastFrameWasRollback}getFrames(){return this.rollbackFrames}getCount(){return this.rollbackFrameCount}getLengths(){return this.rollbackLengths}}exports.SlpParserEvent=void 0,(Pt=exports.SlpParserEvent||(exports.SlpParserEvent={})).SETTINGS="settings",Pt.END="end",Pt.FRAME="frame",Pt.FINALIZED_FRAME="finalized-frame",Pt.ROLLBACK_FRAME="rollback-frame";const Ht={strict:!1};class vt extends o.EventEmitter{constructor(e){super(),this.frames={},this.rollbackCounter=new Ut,this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1,this.options=void 0,this.geckoList=null,this.options=Object.assign({},Ht,e)}handleCommand(e,t){switch(e){case exports.Command.GAME_START:this._handleGameStart(t);break;case exports.Command.FRAME_START:this._handleFrameStart(t);break;case exports.Command.POST_FRAME_UPDATE:this._handlePostFrameUpdate(t),this._handleFrameUpdate(e,t);break;case exports.Command.PRE_FRAME_UPDATE:this._handleFrameUpdate(e,t);break;case exports.Command.ITEM_UPDATE:this._handleItemUpdate(t);break;case exports.Command.FRAME_BOOKEND:this._handleFrameBookend(t);break;case exports.Command.GAME_END:this._handleGameEnd(t);break;case exports.Command.GECKO_LIST:this._handleGeckoList(t)}}reset(){this.frames={},this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=exports.Frames.FIRST-1}getLatestFrameNumber(){var e;return null!=(e=this.latestFrameIndex)?e:exports.Frames.FIRST-1}getPlayableFrameCount(){return null===this.latestFrameIndex||this.latestFrameIndex<exports.Frames.FIRST_PLAYABLE?0:this.latestFrameIndex-exports.Frames.FIRST_PLAYABLE}getLatestFrame(){const e=this.getFrames(),t=null!==this.latestFrameIndex?this.latestFrameIndex:exports.Frames.FIRST;return F.default(e,this.gameEnd?t:t-1)||null}getSettings(){return this.settingsComplete?this.settings:null}getItems(){var e,t;if((null==(e=this.settings)?void 0:e.itemSpawnBehavior)===exports.ItemSpawnType.OFF)return null;const r=null==(t=this.settings)?void 0:t.enabledItems;if(!Xe(r))return null;const n=[];for(let e=0;e<40;e++)1&Math.floor(r/2**e)&&n.push(2**e);return n}getGameEnd(){return this.gameEnd}getFrames(){return this.frames}getRollbackFrames(){return{frames:this.rollbackCounter.getFrames(),count:this.rollbackCounter.getCount(),lengths:this.rollbackCounter.getLengths()}}getFrame(e){return this.frames[e]||null}getGeckoList(){return this.geckoList}_handleGeckoList(e){this.geckoList=e}_handleGameEnd(e){null!==this.latestFrameIndex&&this.latestFrameIndex!==this.lastFinalizedFrame&&this._finalizeFrames(this.latestFrameIndex),this.gameEnd=e,this.emit(exports.SlpParserEvent.END,this.gameEnd)}_handleGameStart(e){this.settings=e,this.settings.players=e.players.filter((e=>3!==e.type)),e.slpVersion&&X.default.gte(e.slpVersion,"1.6.0")&&this._completeSettings()}_handleFrameStart(e){G.default(this.frames,[e.frame,"start"],e)}_handlePostFrameUpdate(e){if(!this.settingsComplete){if(e.frame<=exports.Frames.FIRST){const t=e.playerIndex,r=x.default(this.settings.players,"playerIndex");switch(e.internalCharacterId){case 7:r[t].characterId=19;break;case 19:r[t].characterId=18}}e.frame>exports.Frames.FIRST&&this._completeSettings()}}_handleFrameUpdate(e,t){const r=e===exports.Command.PRE_FRAME_UPDATE?"pre":"post",n=t.isFollower?"followers":"players",s=t.frame;if(this.latestFrameIndex=s,"pre"===r&&!t.isFollower){const e=this.frames[s];this.rollbackCounter.checkIfRollbackFrame(e,t.playerIndex)&&this.emit(exports.SlpParserEvent.ROLLBACK_FRAME,e)}G.default(this.frames,[s,n,t.playerIndex,r],t),G.default(this.frames,[s,"frame"],s);const a=this.getSettings();!a||a.slpVersion&&!X.default.lte(a.slpVersion,"2.2.0")?G.default(this.frames,[s,"isTransferComplete"],!1):(this.emit(exports.SlpParserEvent.FRAME,this.frames[s]),this._finalizeFrames(s-1))}_handleItemUpdate(e){var t,r;const n=e.frame,s=null!=(t=null==(r=this.frames[n])?void 0:r.items)?t:[];s.push(e),G.default(this.frames,[n,"items"],s)}_handleFrameBookend(e){const t=e.latestFinalizedFrame,r=e.frame;if(G.default(this.frames,[r,"isTransferComplete"],!0),this.emit(exports.SlpParserEvent.FRAME,this.frames[r]),this.settings.gameMode===exports.GameMode.ONLINE&&t>=exports.Frames.FIRST){if(this.options.strict&&t<r-7)throw new Error(`latestFinalizedFrame should be within 7 frames of ${r}`);this._finalizeFrames(t)}else this._finalizeFrames(r-7)}_finalizeFrames(e){for(;this.lastFinalizedFrame<e;){const t=this.lastFinalizedFrame+1,r=this.getFrame(t);if(this.options.strict)for(const n of this.settings.players){const s=r.players[n.playerIndex];if(this.settings.players.length>2&&!s)continue;const{pre:a,post:o}=s;if(!a||!o)throw new Error(`Could not finalize frame ${t} of ${e}: missing ${a?"pre":"post"}-frame update for player ${n.playerIndex}`)}this.emit(exports.SlpParserEvent.FINALIZED_FRAME,r),this.lastFinalizedFrame=t}}_completeSettings(){this.settingsComplete||(this.settingsComplete=!0,this.emit(exports.SlpParserEvent.SETTINGS,this.settings))}}exports.ActionsComputer=Re,exports.ComboComputer=Pe,exports.ConsoleCommunication=et,exports.ConsoleConnection=class extends o.EventEmitter{constructor(e){super(),this.ipAddress=void 0,this.port=void 0,this.isRealtime=void 0,this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.connDetails={...tt},this.client=null,this.connection=null,this.options=void 0,this.shouldReconnect=!1,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT,this.isRealtime=!1,this.options=Object.assign({},rt,e)}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{...this.connDetails}}connect(e,t,r=!1,n=2e4){this.ipAddress=e,this.port=t,this.isRealtime=r,this._connectOnPort(e,t,n)}_connectOnPort(e,t,r){const n=b.default((()=>V.default.connect({host:e,port:t,timeout:r})));this._setStatus(exports.ConnectionStatus.CONNECTING);const s=new et,a=n({initialDelay:2e3,maxDelay:1e4,strategy:"fibonacci",failAfter:Infinity},(n=>{var a;this.emit(exports.ConnectionEvent.CONNECT),this.shouldReconnect=this.options.autoReconnect,this.client=n;let o=Qe.INITIAL;n.on("data",(r=>{if(o===Qe.INITIAL&&(o=this._getInitialCommState(r),console.log(`Connected to ${e}:${t} with type: ${o}`),this._setStatus(exports.ConnectionStatus.CONNECTED),console.log(r.toString("hex"))),o===Qe.LEGACY)return void this._handleReplayData(r);try{s.receive(r)}catch(e){return console.error("Failed to process new data from server...",{error:e,prevDataBuf:s.getReceiveBuffer(),rcvData:r}),n.destroy(),void this.emit(exports.ConnectionEvent.ERROR,e)}const a=s.getMessages();try{a.forEach((e=>this._processMessage(e)))}catch(e){console.error(e),n.destroy(),this.emit(exports.ConnectionEvent.ERROR,e)}})),n.on("timeout",(()=>{console.warn(`Attempted connection to ${e}:${t} timed out after ${r}ms`),n.destroy()})),n.on("end",(()=>{console.log("disconnect"),this.shouldReconnect||n.destroy()})),n.on("close",(()=>{console.log("connection was closed")}));const i=s.genHandshakeOut(this.connDetails.gameDataCursor,null!=(a=this.connDetails.clientToken)?a:0,this.isRealtime);n.write(i)})),o=()=>{this._setStatus(this.shouldReconnect?exports.ConnectionStatus.RECONNECT_WAIT:exports.ConnectionStatus.CONNECTING)};a.on("connect",o),a.on("reconnect",o),a.on("disconnect",(()=>{this.shouldReconnect||(a.reconnect=!1,a.disconnect(),this._setStatus(exports.ConnectionStatus.DISCONNECTED))})),a.on("error",(e=>{console.warn(`Connection on port ${t} encountered an error.`,e),this._setStatus(exports.ConnectionStatus.DISCONNECTED),this.emit(exports.ConnectionEvent.ERROR,`Connection on port ${t} encountered an error.\n${e}`)})),this.connection=a,a.connect(t)}disconnect(){this.connection&&(this.connection.reconnect=!1,this.connection.disconnect(),this.connection=null),this.client&&this.client.destroy()}_getInitialCommState(e){if(e.length<13)return Qe.LEGACY;const t=Buffer.from([123,105,4,116,121,112,101,85,1]);return e.slice(4,13).equals(t)?Qe.NORMAL:Qe.LEGACY}_processMessage(e){switch(this.emit(exports.ConnectionEvent.MESSAGE,e),e.type){case exports.CommunicationType.KEEP_ALIVE:const t=Buffer.from("HELO\0");this._handleReplayData(t);break;case exports.CommunicationType.REPLAY:const r=Uint8Array.from(e.payload.pos),n=Buffer.compare(this.connDetails.gameDataCursor,r);if(!e.payload.forcePos&&0!==n)throw new Error(`Position of received data is incorrect. Expected: ${this.connDetails.gameDataCursor.toString()}, Received: ${r.toString()}`);e.payload.forcePos&&console.warn("Overflow occured in Nintendont, data has likely been skipped and replay corrupted. Expected, Received:",this.connDetails.gameDataCursor,r),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.nextPos);const s=Uint8Array.from(e.payload.data);this._handleReplayData(s);break;case exports.CommunicationType.HANDSHAKE:const{nick:a,nintendontVersion:o}=e.payload;a&&(this.connDetails.consoleNick=a);const i=Buffer.from(e.payload.clientToken);this.connDetails.clientToken=i.readUInt32BE(0),o&&(this.connDetails.version=o),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.pos),this.emit(exports.ConnectionEvent.HANDSHAKE,this.connDetails)}}_handleReplayData(e){this.emit(exports.ConnectionEvent.DATA,e)}_setStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}},exports.ConversionComputer=Ue,exports.DolphinConnection=class extends o.EventEmitter{constructor(){super(),this.ipAddress=void 0,this.port=void 0,this.connectionStatus=exports.ConnectionStatus.DISCONNECTED,this.gameCursor=0,this.nickname="unknown",this.version="",this.peer=null,this.ipAddress="0.0.0.0",this.port=exports.Ports.DEFAULT}getStatus(){return this.connectionStatus}getSettings(){return{ipAddress:this.ipAddress,port:this.port}}getDetails(){return{consoleNick:this.nickname,gameDataCursor:this.gameCursor,version:this.version}}async connect(e,t){console.log(`Connecting to: ${e}:${t}`),this.ipAddress=e,this.port=t;const r=await Promise.resolve().then((function(){return g(require("enet"))})),n=r.createClient({peers:32,channels:3,down:0,up:0},(e=>{e&&console.error(e)}));this.peer=n.connect({address:this.ipAddress,port:this.port},3,1337,((e,t)=>{e?console.error(e):(t.ping(),this.emit(exports.ConnectionEvent.CONNECT),this._setStatus(exports.ConnectionStatus.CONNECTED))})),this.peer.on("connect",(()=>{this.gameCursor=0;const e=new r.Packet(JSON.stringify({type:"connect_request",cursor:this.gameCursor}),r.PACKET_FLAG.RELIABLE);this.peer.send(0,e)})),this.peer.on("message",(e=>{const t=e.data();if(0===t.length)return;const r=t.toString("ascii"),n=JSON.parse(r),{dolphin_closed:s}=n;if(s)this.disconnect();else switch(this.emit(exports.ConnectionEvent.MESSAGE,n),n.type){case exports.DolphinMessageType.CONNECT_REPLY:this.connectionStatus=exports.ConnectionStatus.CONNECTED,this.gameCursor=n.cursor,this.nickname=n.nick,this.version=n.version,this.emit(exports.ConnectionEvent.HANDSHAKE,this.getDetails());break;case exports.DolphinMessageType.GAME_EVENT:{const{payload:e}=n;if(!e)return void this.disconnect();this._updateCursor(n,r);const t=Buffer.from(e,"base64");this._handleReplayData(t);break}case exports.DolphinMessageType.START_GAME:case exports.DolphinMessageType.END_GAME:this._updateCursor(n,r)}})),this.peer.on("disconnect",(()=>{this.disconnect()})),this._setStatus(exports.ConnectionStatus.CONNECTING)}disconnect(){this.peer&&(this.peer.disconnect(),this.peer=null),this._setStatus(exports.ConnectionStatus.DISCONNECTED)}_handleReplayData(e){this.emit(exports.ConnectionEvent.DATA,e)}_setStatus(e){this.connectionStatus!==e&&(this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus))}_updateCursor(e,t){const{cursor:r,next_cursor:n}=e;if(this.gameCursor!==r){const e=new Error(`Unexpected game data cursor. Expected: ${this.gameCursor} but got: ${r}. Payload: ${t}`);console.warn(e),this.emit(exports.ConnectionEvent.ERROR,e)}this.gameCursor=n}},exports.InputComputer=He,exports.MAX_ROLLBACK_FRAMES=7,exports.NETWORK_MESSAGE="HELO\0",exports.SlippiGame=class{constructor(e,t){if(this.input=void 0,this.metadata=null,this.finalStats=null,this.parser=void 0,this.readPosition=null,this.actionsComputer=new Re,this.conversionComputer=new Ue,this.comboComputer=new Pe,this.stockComputer=new Je,this.inputComputer=new He,this.targetBreakComputer=new je,this.statsComputer=void 0,"string"==typeof e)this.input={source:exports.SlpInputSource.FILE,filePath:e};else if(e instanceof Buffer)this.input={source:exports.SlpInputSource.BUFFER,buffer:e};else{if(!(e instanceof ArrayBuffer))throw new Error("Cannot create SlippiGame with input of that type");this.input={source:exports.SlpInputSource.BUFFER,buffer:Buffer.from(e)}}this.statsComputer=new Ye(t),this.statsComputer.register(this.actionsComputer,this.comboComputer,this.conversionComputer,this.inputComputer,this.stockComputer,this.targetBreakComputer),this.parser=new vt,this.parser.on(exports.SlpParserEvent.SETTINGS,(e=>{this.statsComputer.setup(e)})),this.parser.on(exports.SlpParserEvent.FINALIZED_FRAME,(e=>{this.statsComputer.addFrame(e)}))}_process(e=(()=>!1),t){if(null!==this.parser.getGameEnd())return;const r=null!=t?t:Et(this.input);this.readPosition=_t(r,((t,r)=>!!r&&(this.parser.handleCommand(t,r),e(t,r))),this.readPosition),t||Tt(r)}getSettings(){return this._process((()=>null!==this.parser.getSettings())),this.parser.getSettings()}getItems(){return this._process(),this.parser.getItems()}getLatestFrame(){return this._process(),this.parser.getLatestFrame()}getGameEnd(e={}){if(null!=e&&e.skipProcessing){const e=Et(this.input),t=Ct(e);return Tt(e),t}return this._process(),this.parser.getGameEnd()}getFrames(){return this._process(),this.parser.getFrames()}getRollbackFrames(){return this._process(),this.parser.getRollbackFrames()}getGeckoList(){return this._process((()=>null!==this.parser.getGeckoList())),this.parser.getGeckoList()}getStats(){if(this.finalStats)return this.finalStats;this._process();const e=this.parser.getSettings();if(!e)return null;this.statsComputer.process();const t=this.inputComputer.fetch(),r=this.stockComputer.fetch(),n=this.conversionComputer.fetch(),s=this.parser.getPlayableFrameCount(),a=we({settings:e,inputs:t,conversions:n,playableFrameCount:s}),o=null!==this.parser.getGameEnd(),i={lastFrame:this.parser.getLatestFrameNumber(),playableFrameCount:s,stocks:r,conversions:n,combos:this.comboComputer.fetch(),actionCounts:this.actionsComputer.fetch(),overall:a,gameComplete:o};return o&&(this.finalStats=i),i}getStadiumStats(){this._process();const e=this.parser.getSettings();if(!e)return null;const t=this.parser.getLatestFrame();if(!(null==t?void 0:t.players))return null;switch(this.statsComputer.process(),e.gameMode){case exports.GameMode.TARGET_TEST:return{type:"target-test",targetBreaks:this.targetBreakComputer.fetch()};case exports.GameMode.HOME_RUN_CONTEST:const r=function(e,t){var r;const n=Object.values(t.players).filter(Xe).find((e=>32===e.post.internalCharacterId));if(!n)return null;const s=e.language===exports.Language.JAPANESE?"meters":"feet",a=function(e,t="feet"){let r=0;switch(t){case"feet":r=10*Math.floor(e-66.67234),r=Math.fround(r),r=Math.floor(r/30.4788*10)/10;break;case"meters":r=10*Math.floor(e-70*1.04167),r=Math.fround(r),r=Math.floor(r/100*10)/10;break;default:throw new Error(`Unsupported units: ${t}`)}return r=Math.round(10*r)/10,Math.max(0,r)}(null!=(r=n.post.positionX)?r:0,s);return{distance:a,units:s}}(e,t);return r?{type:"home-run-contest",distance:r.distance,units:r.units}:null;default:return null}}getMetadata(){if(this.metadata)return this.metadata;const e=Et(this.input);return this.metadata=It(e),Tt(e),this.metadata}getFilePath(){var e;return this.input.source!==exports.SlpInputSource.FILE?null:null!=(e=this.input.filePath)?e:null}getWinners(){const e=Et(this.input),t=Ct(e);this._process((()=>null!==this.parser.getSettings()),e);const r=this.parser.getSettings();if(!t||!r)return Tt(e),[];let n=[];return t.gameEndMethod===exports.GameEndMethod.TIME&&(n=Ot(e)),Tt(e),function(e,t,r){var n,s;const{placements:a,gameEndMethod:o,lrasInitiatorIndex:i}=e,{players:l,isTeams:E}=t;if(o===exports.GameEndMethod.NO_CONTEST||o===exports.GameEndMethod.UNRESOLVED){if(Xe(i)&&2===l.length){var T;const e=null==(T=l.find((({playerIndex:e})=>e!==i)))?void 0:T.playerIndex;if(Xe(e))return[{playerIndex:e,position:0}]}return[]}if(o===exports.GameEndMethod.TIME&&2===l.length){const e=r.filter((e=>!e.isFollower));if(e.length!==l.length)return[];const t=e[0],n=e[1];if(t.stocksRemaining>n.stocksRemaining)return[{playerIndex:t.playerIndex,position:0}];if(n.stocksRemaining>t.stocksRemaining)return[{playerIndex:n.playerIndex,position:0}];const s=Math.trunc(t.percent),a=Math.trunc(n.percent);return s<a?[{playerIndex:t.playerIndex,position:0}]:a<s?[{playerIndex:n.playerIndex,position:0}]:[]}const c=a.find((e=>0===e.position));if(!c)return[];const u=null!=(n=null==(s=l.find((({playerIndex:e})=>e===c.playerIndex)))?void 0:s.teamId)?n:null;return E&&Xe(u)?a.filter((e=>{var t,r;return(null!=(t=null==(r=l.find((({playerIndex:t})=>t===e.playerIndex)))?void 0:r.teamId)?t:null)===u})):[c]}(t,r,n)}},exports.SlpFile=Mt,exports.SlpFileWriter=class extends Dt{constructor(e,t){super(e,t),this.currentFile=null,this.options=void 0,this.options=Object.assign({},yt,e),this._setupListeners()}_writePayload(e){this.currentFile&&this.currentFile.write(e)}_setupListeners(){this.on(exports.SlpStreamEvent.RAW,(e=>{const{command:t,payload:r}=e;switch(t){case exports.Command.MESSAGE_SIZES:this._handleNewGame(),this._writePayload(r);break;case exports.Command.GAME_END:this._writePayload(r),this._handleEndGame();break;default:this._writePayload(r)}}))}getCurrentFilename(){return null!==this.currentFile?J.default.resolve(this.currentFile.path()):null}endCurrentFile(){this._handleEndGame()}updateSettings(e){this.options=Object.assign({},this.options,e)}_handleNewGame(){if(this.options.outputFiles){const e=this.options.newFilename(this.options.folderPath,new Date);this.currentFile=new Mt(e,this),this.emit(exports.SlpFileWriterEvent.NEW_FILE,e)}}_handleEndGame(){this.currentFile&&(this.currentFile.setMetadata({consoleNickname:this.options.consoleNickname}),this.currentFile.end(),this.emit(exports.SlpFileWriterEvent.FILE_COMPLETE,this.currentFile.path()),this.currentFile=null)}},exports.SlpParser=vt,exports.SlpStream=Dt,exports.Stats=Ye,exports.StockComputer=Je,exports.TargetBreakComputer=je,exports.Timers=Te,exports.animations={__proto__:null,getDeathDirection:function(e){if(e>10)return null;switch(e){case 0:return"down";case 1:return"left";case 2:return"right";default:return"up"}}},exports.calcDamageTaken=Ne,exports.characters=Z,exports.closeSlpFile=Tt,exports.didLoseStock=ue,exports.extractFinalPostFrameUpdates=Ot,exports.frameToGameTimer=function(e,t){const{timerType:r,startingTimerSeconds:n}=t;if(r===exports.TimerType.DECREASING){if(!Xe(n))return"Unknown";const t=Math.ceil((60-e%60)%60*99/59),r=new Date(0,0,0,0,0,n-e/60,10*t);return p.format(r,"mm:ss.SS")}if(r===exports.TimerType.INCREASING){const t=Math.floor(e%60*99/59),r=new Date(0,0,0,0,0,e/60,10*t);return p.format(r,"mm:ss.SS")}return"Infinite"},exports.generateOverallStats=we,exports.getGameEnd=Ct,exports.getMetadata=It,exports.getSinglesPlayerPermutationsFromSettings=ce,exports.isCommandGrabbed=Se,exports.isDamaged=me,exports.isDead=de,exports.isDown=Ae,exports.isGrabbed=he,exports.isInControl=_e,exports.isTeching=pe,exports.iterateEvents=_t,exports.moves=re,exports.openSlpFile=Et,exports.parseMessage=pt,exports.stages=Ee;
//# sourceMappingURL=slippi-js.cjs.production.min.js.map
